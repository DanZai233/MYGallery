<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYGallery - åå°ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .upload-area.dragover {
            background-color: #EFF6FF;
            border-color: #3B82F6;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen px-4">
        <div class="w-full max-w-md glass-effect rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">ğŸ“·</div>
                <h1 class="text-3xl font-bold text-gray-800">MYGallery</h1>
                <p class="text-gray-600 mt-2">åå°ç®¡ç†ç³»ç»Ÿ</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">ç”¨æˆ·å</label>
                    <input type="text" id="username" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                           placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜è´¦å·">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">å¯†ç </label>
                    <input type="password" id="password" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                           placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                
                <div id="login-error" class="hidden text-red-600 text-sm text-center"></div>
                
                <button type="submit"
                        class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition shadow-lg">
                    ç™»å½•
                </button>
            </form>
            
            <div class="mt-6 text-center text-gray-500 text-sm">
                <a href="/" class="text-blue-600 hover:underline">è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†ç•Œé¢ -->
    <div id="admin-dashboard" class="hidden">
        <div class="flex min-h-screen">
            <!-- ä¾§è¾¹æ  (ChronoFrame-style) -->
            <aside class="w-60 bg-white border-r border-gray-200 fixed top-0 left-0 bottom-0 z-40 flex flex-col hidden md:flex">
                <div class="p-5 border-b border-gray-100">
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">ğŸ“·</span>
                        <h1 class="text-lg font-bold text-gray-800">MYGallery</h1>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">ç®¡ç†åå°</p>
                </div>
                <nav class="flex-1 p-3 space-y-1">
                    <a href="/admin" class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-blue-50 text-blue-700 font-medium text-sm">
                        <span>ğŸ“Š</span> ä»ªè¡¨ç›˜
                    </a>
                    <a href="/categories.html" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 text-sm transition">
                        <span>ğŸ“</span> åˆ†ç±»ç®¡ç†
                    </a>
                    <a href="/admin-albums.html" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 text-sm transition">
                        <span>ğŸ“‚</span> ç›¸å†Œç®¡ç†
                    </a>
                    <a href="/settings.html" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 text-sm transition">
                        <span>âš™ï¸</span> ç½‘ç«™è®¾ç½®
                    </a>
                    <a href="/map.html" target="_blank" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 text-sm transition">
                        <span>ğŸ—ºï¸</span> ç…§ç‰‡åœ°å›¾
                    </a>
                    <a href="/" target="_blank" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 text-sm transition">
                        <span>ğŸ </span> æŸ¥çœ‹å‰å°
                    </a>
                </nav>
                <div class="p-4 border-t border-gray-100">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-500" id="admin-username"></span>
                        <button onclick="logout()" class="text-sm text-gray-400 hover:text-red-500 transition">é€€å‡º</button>
                    </div>
                </div>
            </aside>

            <!-- ç§»åŠ¨ç«¯é¡¶æ  -->
            <header class="glass-effect fixed top-0 left-0 right-0 z-50 shadow-lg md:hidden">
                <div class="px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center space-x-2"><span class="text-xl">ğŸ“·</span><h1 class="text-lg font-bold text-gray-800">ç®¡ç†åå°</h1></div>
                    <div class="flex items-center space-x-3">
                        <a href="/categories.html" class="text-sm text-gray-600">ğŸ“</a>
                        <a href="/settings.html" class="text-sm text-gray-600">âš™ï¸</a>
                        <button onclick="logout()" class="text-sm text-gray-400 hover:text-red-500">é€€å‡º</button>
                    </div>
                </div>
            </header>

            <!-- ä¸»å†…å®¹ -->
            <main class="flex-1 md:ml-60 pt-16 md:pt-0 px-4 md:px-8 pb-12">
                <!-- ç»Ÿè®¡é¢æ¿ -->
                <div class="pt-6 md:pt-8 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">ä»ªè¡¨ç›˜</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                            <div class="flex items-center justify-between">
                                <div><p class="text-gray-400 text-xs font-medium uppercase tracking-wider">ç…§ç‰‡æ€»æ•°</p><p class="text-3xl font-bold text-gray-800 mt-1" id="total-photos">0</p></div>
                                <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-2xl">ğŸ“¸</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                            <div class="flex items-center justify-between">
                                <div><p class="text-gray-400 text-xs font-medium uppercase tracking-wider">æ€»æµè§ˆé‡</p><p class="text-3xl font-bold text-gray-800 mt-1" id="total-views">0</p></div>
                                <div class="w-12 h-12 bg-purple-50 rounded-xl flex items-center justify-center text-2xl">ğŸ‘ï¸</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                            <div class="flex items-center justify-between">
                                <div><p class="text-gray-400 text-xs font-medium uppercase tracking-wider">å­˜å‚¨ç©ºé—´</p><p class="text-3xl font-bold text-gray-800 mt-1" id="storage-size">0 MB</p></div>
                                <div class="w-12 h-12 bg-green-50 rounded-xl flex items-center justify-center text-2xl">ğŸ’¾</div>
                            </div>
                        </div>
                    </div>
                </div>
            
            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ä¸Šä¼ ç…§ç‰‡</h2>
                
                <div id="upload-area" 
                     class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer hover:border-blue-500 transition">
                    <div class="text-5xl mb-4">â˜ï¸</div>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">æ‹–æ”¾ç…§ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</h3>
                    <p class="text-gray-500 text-sm mb-4">æ”¯æŒ JPG, PNG, GIF, WebP æ ¼å¼ï¼Œæœ€å¤§ 50MB</p>
                    <button onclick="document.getElementById('file-input').click()"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                    <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                </div>

                <!-- ä¸Šä¼ é˜Ÿåˆ— -->
                <div id="upload-queue" class="mt-6 hidden space-y-3"></div>
            </div>

            <!-- ç…§ç‰‡åˆ—è¡¨ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">ç…§ç‰‡ç®¡ç†</h2>
                    <div class="flex items-center gap-2">
                        <div id="batch-bar" class="hidden flex items-center gap-2">
                            <span class="text-sm text-gray-500" id="select-count">å·²é€‰ 0</span>
                            <button onclick="batchDelete()" class="px-3 py-1.5 bg-red-50 text-red-600 rounded-lg text-sm hover:bg-red-100">æ‰¹é‡åˆ é™¤</button>
                            <button onclick="clearSelection()" class="px-3 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200">å–æ¶ˆ</button>
                        </div>
                        <button onclick="toggleSelectMode()" class="px-3 py-1.5 bg-gray-100 rounded-lg text-sm hover:bg-gray-200" id="select-btn">â˜‘ é€‰æ‹©</button>
                        <button onclick="loadPhotos()" class="px-3 py-1.5 bg-gray-100 rounded-lg text-sm hover:bg-gray-200">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
                
                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="photos-loading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-gray-500 mt-4">åŠ è½½ä¸­...</p>
                </div>

                <!-- ç…§ç‰‡ç½‘æ ¼ -->
                <div id="photos-grid" class="hidden grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- ç…§ç‰‡é¡¹é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div id="photos-empty" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">ğŸ“¸</div>
                    <p class="text-gray-500">è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•ç…§ç‰‡</p>
                </div>
            </div>
            </main>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">ç¼–è¾‘ç…§ç‰‡ä¿¡æ¯</h2>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-photo-id">
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">æ ‡é¢˜</label>
                    <input type="text" id="edit-title"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">æè¿°</label>
                    <textarea id="edit-description" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)</label>
                    <input type="text" id="edit-tags"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                           placeholder="é£æ™¯, æ—…è¡Œ, æ—¥è½">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">ä½ç½®</label>
                    <input type="text" id="edit-location"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                           placeholder="åŒ—äº¬Â·æ•…å®«">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">åˆ†ç±»</label>
                    <input type="text" id="edit-category"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                           placeholder="é£æ™¯">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">ç‰ˆæƒä¿¡æ¯</label>
                    <input type="text" id="edit-copyright"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                           placeholder="Â© 2025 ç‰ˆæƒæ‰€æœ‰">
                </div>
                
                <!-- EXIF å…ƒæ•°æ®ç¼–è¾‘ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
                    <h3 class="font-medium text-gray-800 mb-4 flex items-center">
                        <span class="text-xl mr-2">ğŸ“¸</span>
                        ç›¸æœºå…ƒæ•°æ®ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm mb-2">ç›¸æœºå“ç‰Œ</label>
                            <input type="text" id="edit-camera-make"
                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                   placeholder="Sony">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-2">ç›¸æœºå‹å·</label>
                            <input type="text" id="edit-camera-model"
                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                   placeholder="A7R IV">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-2">é•œå¤´å‹å·</label>
                            <input type="text" id="edit-lens-model"
                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                   placeholder="FE 24-70mm F2.8 GM">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-2">ç„¦è·</label>
                            <input type="text" id="edit-focal-length"
                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                   placeholder="35mm">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-2">å…‰åœˆ</label>
                            <input type="text" id="edit-aperture"
                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                   placeholder="f/2.8">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-2">å¿«é—¨é€Ÿåº¦</label>
                            <input type="text" id="edit-shutter-speed"
                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                   placeholder="1/250s">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-2">ISO</label>
                            <input type="text" id="edit-iso"
                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                   placeholder="400">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-2">æ‹æ‘„æ—¶é—´</label>
                            <input type="datetime-local" id="edit-date-taken"
                                   class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeEditModal()"
                            class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        å–æ¶ˆ
                    </button>
                    <button type="submit"
                            class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('admin_token');
        let currentUser = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            if (token) {
                checkAuth();
            }
            
            setupDragDrop();
            setupFileInput();
        });

        // ç™»å½•
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    currentUser = data.user;
                    localStorage.setItem('admin_token', token);
                    showDashboard();
                } else {
                    const error = await response.json();
                    errorDiv.textContent = error.error || 'ç™»å½•å¤±è´¥';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                errorDiv.classList.remove('hidden');
            }
        });

        // æ£€æŸ¥è®¤è¯
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/photos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showDashboard();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        // æ˜¾ç¤ºç®¡ç†ç•Œé¢
        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('admin-username').textContent = currentUser.username;
            }
            loadPhotos();
            updateStats();
        }

        // ç™»å‡º
        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('admin_token');
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        // åŠ è½½ç…§ç‰‡åˆ—è¡¨
        async function loadPhotos() {
            const loading = document.getElementById('photos-loading');
            const grid = document.getElementById('photos-grid');
            const empty = document.getElementById('photos-empty');
            
            loading.classList.remove('hidden');
            grid.classList.add('hidden');
            empty.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/photos?size=100`);
                const data = await response.json();
                
                if (data.photos && data.photos.length > 0) {
                    grid.innerHTML = data.photos.map(photo => createPhotoCard(photo)).join('');
                    grid.classList.remove('hidden');
                } else {
                    empty.classList.remove('hidden');
                }
                
                loading.classList.add('hidden');
            } catch (error) {
                console.error('åŠ è½½ç…§ç‰‡å¤±è´¥:', error);
                loading.classList.add('hidden');
            }
        }

        // åˆ›å»ºç…§ç‰‡å¡ç‰‡
        let selectMode=false, selectedIds=new Set();
        function toggleSelectMode(){selectMode=!selectMode;selectedIds.clear();document.getElementById('select-btn').textContent=selectMode?'âœ• å–æ¶ˆé€‰æ‹©':'â˜‘ é€‰æ‹©';document.getElementById('batch-bar').classList.toggle('hidden',!selectMode);updateSelectCount();loadPhotos()}
        function clearSelection(){selectedIds.clear();updateSelectCount();document.querySelectorAll('.photo-check').forEach(c=>c.checked=false)}
        function toggleSelect(id,el){if(el.checked)selectedIds.add(id);else selectedIds.delete(id);updateSelectCount()}
        function updateSelectCount(){document.getElementById('select-count').textContent=`å·²é€‰ ${selectedIds.size}`;document.getElementById('batch-bar').classList.toggle('hidden',!selectMode)}
        async function batchDelete(){if(selectedIds.size===0)return;if(!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedIds.size} å¼ ç…§ç‰‡ï¼Ÿä¸å¯æ¢å¤ã€‚`))return;for(const id of selectedIds){await fetch(`${API_BASE}/photos/${id}`,{method:'DELETE',headers:{'Authorization':`Bearer ${token}`}})}selectedIds.clear();loadPhotos();updateStats();updateSelectCount()}

        function createPhotoCard(photo) {
            return `
                <div class="relative group">
                    ${selectMode?`<input type="checkbox" class="photo-check absolute top-2 left-2 z-10 w-5 h-5 accent-blue-600 cursor-pointer" onchange="toggleSelect(${photo.id},this)" ${selectedIds.has(photo.id)?'checked':''}>`:''}
                    <img src="${photo.thumbnail_url || photo.url}" 
                         alt="${photo.title || photo.original_name}"
                         class="w-full h-40 object-cover rounded-lg" ${selectMode?`onclick="event.preventDefault();const c=this.parentElement.querySelector('.photo-check');c.checked=!c.checked;toggleSelect(${photo.id},c)"`:''}>
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 ${selectMode?'pointer-events-none':''}">
                        <button onclick="editPhoto(${photo.id})" class="px-3 py-1 bg-blue-600 text-white rounded mr-2 hover:bg-blue-700">ç¼–è¾‘</button>
                        <button onclick="deletePhoto(${photo.id})" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">åˆ é™¤</button>
                    </div>
                    <p class="mt-2 text-sm text-gray-700 truncate">${photo.title || photo.original_name}</p>
                </div>
            `;
        }

        // æ›´æ–°ç»Ÿè®¡
        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE}/photos?size=1`);
                const data = await response.json();
                
                document.getElementById('total-photos').textContent = data.total;
                
                // è®¡ç®—æ€»æµè§ˆé‡å’Œå­˜å‚¨å¤§å°
                const allResponse = await fetch(`${API_BASE}/photos?size=1000`);
                const allData = await allResponse.json();
                
                let totalViews = 0;
                let totalSize = 0;
                
                if (allData.photos) {
                    allData.photos.forEach(photo => {
                        totalViews += photo.views || 0;
                        totalSize += photo.file_size || 0;
                    });
                }
                
                document.getElementById('total-views').textContent = totalViews;
                document.getElementById('storage-size').textContent = (totalSize / 1024 / 1024).toFixed(2) + ' MB';
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // è®¾ç½®æ‹–æ”¾ä¸Šä¼ 
        function setupDragDrop() {
            const uploadArea = document.getElementById('upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
        }

        // è®¾ç½®æ–‡ä»¶é€‰æ‹©
        function setupFileInput() {
            document.getElementById('file-input').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFiles(files) {
            const queue = document.getElementById('upload-queue');
            queue.classList.remove('hidden');
            
            for (const file of files) {
                await uploadFile(file);
            }
            
            loadPhotos();
            updateStats();
        }

        // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        function uploadFile(file) {
            return new Promise((resolve) => {
                const queue = document.getElementById('upload-queue');
                const item = document.createElement('div');
                item.className = 'bg-gray-50 p-4 rounded-lg';
                item.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 truncate" style="max-width:60%">${file.name}</span>
                        <span class="text-sm text-gray-400" id="upload-stats">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="bg-blue-600 h-1.5 rounded-full transition-all duration-200" style="width:0%"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1.5">å‡†å¤‡ä¸­...</p>
                `;
                queue.appendChild(item);
                const bar = item.querySelector('.bg-blue-600');
                const stats = item.querySelector('#upload-stats');
                const msg = item.querySelector('p');
                const startTime = Date.now();

                const xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round(e.loaded / e.total * 100);
                        bar.style.width = pct + '%';
                        stats.textContent = pct + '%';
                        const elapsed = (Date.now() - startTime) / 1000;
                        const speed = e.loaded / elapsed;
                        const remaining = (e.total - e.loaded) / speed;
                        const speedStr = speed > 1048576 ? (speed/1048576).toFixed(1)+' MB/s' : (speed/1024).toFixed(0)+' KB/s';
                        msg.textContent = pct < 100 ? `${speedStr} Â· å‰©ä½™ ${Math.ceil(remaining)}s` : 'å¤„ç†ä¸­...';
                    }
                });
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        bar.style.width = '100%';
                        bar.className = 'bg-green-500 h-1.5 rounded-full';
                        stats.textContent = 'âœ“';
                        msg.textContent = 'ä¸Šä¼ æˆåŠŸ';
                        msg.className = 'text-xs text-green-600 mt-1.5';
                        setTimeout(() => item.remove(), 2500);
                    } else {
                        let errMsg = 'æœªçŸ¥é”™è¯¯';
                        try { errMsg = JSON.parse(xhr.responseText).error || errMsg; } catch(e){}
                        bar.className = 'bg-red-500 h-1.5 rounded-full';
                        msg.textContent = 'å¤±è´¥: ' + errMsg;
                        msg.className = 'text-xs text-red-500 mt-1.5';
                    }
                    resolve();
                });
                xhr.addEventListener('error', () => {
                    bar.className = 'bg-red-500 h-1.5 rounded-full';
                    msg.textContent = 'ç½‘ç»œé”™è¯¯';
                    msg.className = 'text-xs text-red-500 mt-1.5';
                    resolve();
                });

                const formData = new FormData();
                formData.append('photo', file);
                xhr.open('POST', `${API_BASE}/photos`);
                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                xhr.send(formData);
            });
        }

        // ç¼–è¾‘ç…§ç‰‡
        async function editPhoto(id) {
            try {
                const response = await fetch(`${API_BASE}/photos/${id}`);
                const photo = await response.json();
                
                document.getElementById('edit-photo-id').value = photo.id;
                document.getElementById('edit-title').value = photo.title || '';
                document.getElementById('edit-description').value = photo.description || '';
                document.getElementById('edit-tags').value = photo.tags || '';
                document.getElementById('edit-location').value = photo.location || '';
                document.getElementById('edit-category').value = photo.category || '';
                document.getElementById('edit-copyright').value = photo.copyright || '';
                
                // EXIF å…ƒæ•°æ®
                document.getElementById('edit-camera-make').value = photo.camera_make || '';
                document.getElementById('edit-camera-model').value = photo.camera_model || '';
                document.getElementById('edit-lens-model').value = photo.lens_model || '';
                document.getElementById('edit-focal-length').value = photo.focal_length || '';
                document.getElementById('edit-aperture').value = photo.aperture || '';
                document.getElementById('edit-shutter-speed').value = photo.shutter_speed || '';
                document.getElementById('edit-iso').value = photo.iso || '';
                
                if (photo.date_taken) {
                    const date = new Date(photo.date_taken);
                    const localDate = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
                    document.getElementById('edit-date-taken').value = localDate.toISOString().slice(0, 16);
                }
                
                document.getElementById('edit-modal').classList.remove('hidden');
            } catch (error) {
                alert('åŠ è½½ç…§ç‰‡ä¿¡æ¯å¤±è´¥');
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        // ä¿å­˜ç¼–è¾‘
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('edit-photo-id').value;
            const formData = new FormData();
            formData.append('title', document.getElementById('edit-title').value);
            formData.append('description', document.getElementById('edit-description').value);
            formData.append('tags', document.getElementById('edit-tags').value);
            formData.append('location', document.getElementById('edit-location').value);
            formData.append('category', document.getElementById('edit-category').value);
            formData.append('copyright', document.getElementById('edit-copyright').value);
            
            // EXIF å…ƒæ•°æ®
            formData.append('camera_make', document.getElementById('edit-camera-make').value);
            formData.append('camera_model', document.getElementById('edit-camera-model').value);
            formData.append('lens_model', document.getElementById('edit-lens-model').value);
            formData.append('focal_length', document.getElementById('edit-focal-length').value);
            formData.append('aperture', document.getElementById('edit-aperture').value);
            formData.append('shutter_speed', document.getElementById('edit-shutter-speed').value);
            formData.append('iso', document.getElementById('edit-iso').value);
            
            const dateTaken = document.getElementById('edit-date-taken').value;
            if (dateTaken) {
                formData.append('date_taken', new Date(dateTaken).toISOString());
            }
            
            try {
                const response = await fetch(`${API_BASE}/photos/${id}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (response.ok) {
                    closeEditModal();
                    loadPhotos();
                    alert('æ›´æ–°æˆåŠŸï¼');
                } else {
                    const error = await response.json();
                    alert('æ›´æ–°å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥: ç½‘ç»œé”™è¯¯');
            }
        });

        // åˆ é™¤ç…§ç‰‡
        async function deletePhoto(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/photos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadPhotos();
                    updateStats();
                    alert('åˆ é™¤æˆåŠŸï¼');
                } else {
                    const error = await response.json();
                    alert('åˆ é™¤å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ç½‘ç»œé”™è¯¯');
            }
        }
    </script>
</body>
</html>

