<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»ç®¡ç† - MYGallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white shadow-lg fixed top-0 left-0 right-0 z-50">
        <div class="px-6 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <a href="/admin" class="text-2xl hover:opacity-80">â†</a>
                <h1 class="text-xl font-bold text-gray-800">åˆ†ç±»ç®¡ç†</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="showAddModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    â• æ–°å»ºåˆ†ç±»
                </button>
                <a href="/admin" class="px-4 py-2 text-gray-700 hover:text-blue-600">è¿”å›ç®¡ç†</a>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <main class="pt-24 px-6 pb-12 max-w-6xl mx-auto">
        <!-- åˆ†ç±»åˆ—è¡¨ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div id="categories-loading" class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600 mx-auto"></div>
                <p class="text-gray-500 mt-4">åŠ è½½ä¸­...</p>
            </div>

            <div id="categories-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- åˆ†ç±»å¡ç‰‡é€šè¿‡ JS ç”Ÿæˆ -->
            </div>

            <div id="categories-empty" class="hidden text-center py-12">
                <div class="text-6xl mb-4">ğŸ“</div>
                <p class="text-gray-500 mb-4">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•åˆ†ç±»</p>
                <button onclick="showAddModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    åˆ›å»ºç¬¬ä¸€ä¸ªåˆ†ç±»
                </button>
            </div>
        </div>
    </main>

    <!-- æ–°å»º/ç¼–è¾‘åˆ†ç±»æ¨¡æ€æ¡† -->
    <div id="category-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800" id="modal-title">æ–°å»ºåˆ†ç±»</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <form id="category-form" class="space-y-4">
                <input type="hidden" id="category-id">
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">åˆ†ç±»åç§° *</label>
                    <input type="text" id="category-name" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                           placeholder="å¦‚ï¼šé£æ™¯ã€äººåƒã€åŸå¸‚">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">URLæ ‡è¯† *</label>
                    <input type="text" id="category-slug" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                           placeholder="å¦‚ï¼šlandscape, portraitï¼ˆä»…å­—æ¯æ•°å­—å’Œ-ï¼‰">
                    <p class="text-xs text-gray-500 mt-1">ç”¨äºURLï¼Œå»ºè®®ä½¿ç”¨è‹±æ–‡</p>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">æè¿°</label>
                    <textarea id="category-description" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                              placeholder="åˆ†ç±»çš„ç®€çŸ­æè¿°"></textarea>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-medium mb-2">æ’åºé¡ºåº</label>
                    <input type="number" id="category-order" value="0"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                           placeholder="0">
                    <p class="text-xs text-gray-500 mt-1">æ•°å­—è¶Šå°è¶Šé å‰</p>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeModal()"
                            class="flex-1 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        å–æ¶ˆ
                    </button>
                    <button type="submit"
                            class="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let token = localStorage.getItem('admin_token');

        if (!token) {
            window.location.href = '/admin';
        }

        // åŠ è½½åˆ†ç±»åˆ—è¡¨
        async function loadCategories() {
            const loading = document.getElementById('categories-loading');
            const grid = document.getElementById('categories-grid');
            const empty = document.getElementById('categories-empty');
            
            loading.classList.remove('hidden');
            grid.classList.add('hidden');
            empty.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_BASE}/categories`);
                const categories = await response.json();
                
                if (categories && categories.length > 0) {
                    grid.innerHTML = categories.map(cat => createCategoryCard(cat)).join('');
                    grid.classList.remove('hidden');
                } else {
                    empty.classList.remove('hidden');
                }
                
                loading.classList.add('hidden');
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                loading.innerHTML = '<p class="text-red-600">åŠ è½½å¤±è´¥</p>';
            }
        }

        // åˆ›å»ºåˆ†ç±»å¡ç‰‡
        function createCategoryCard(category) {
            return `
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-lg transition">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 mb-1">${category.name}</h3>
                            <p class="text-sm text-gray-500">æ ‡è¯†: ${category.slug}</p>
                        </div>
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${category.photo_count || 0} å¼ </span>
                    </div>
                    
                    ${category.description ? `<p class="text-gray-600 text-sm mb-4">${category.description}</p>` : ''}
                    
                    <div class="flex space-x-2">
                        <button onclick="editCategory(${category.id})" 
                                class="flex-1 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm">
                            âœï¸ ç¼–è¾‘
                        </button>
                        <button onclick="deleteCategory(${category.id}, '${category.name}')" 
                                class="flex-1 px-3 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded text-sm">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºæ–°å»ºæ¨¡æ€æ¡†
        function showAddModal() {
            document.getElementById('modal-title').textContent = 'æ–°å»ºåˆ†ç±»';
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            document.getElementById('category-modal').classList.remove('hidden');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('category-modal').classList.add('hidden');
        }

        // ç¼–è¾‘åˆ†ç±»
        async function editCategory(id) {
            try {
                const response = await fetch(`${API_BASE}/categories`);
                const categories = await response.json();
                const category = categories.find(c => c.id === id);
                
                if (category) {
                    document.getElementById('modal-title').textContent = 'ç¼–è¾‘åˆ†ç±»';
                    document.getElementById('category-id').value = category.id;
                    document.getElementById('category-name').value = category.name;
                    document.getElementById('category-slug').value = category.slug;
                    document.getElementById('category-description').value = category.description || '';
                    document.getElementById('category-order').value = category.sort_order || 0;
                    document.getElementById('category-modal').classList.remove('hidden');
                }
            } catch (error) {
                alert('åŠ è½½åˆ†ç±»ä¿¡æ¯å¤±è´¥');
            }
        }

        // ä¿å­˜åˆ†ç±»
        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('category-id').value;
            const data = {
                name: document.getElementById('category-name').value,
                slug: document.getElementById('category-slug').value,
                description: document.getElementById('category-description').value,
                sort_order: parseInt(document.getElementById('category-order').value) || 0
            };
            
            try {
                const url = id ? `${API_BASE}/categories/${id}` : `${API_BASE}/categories`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closeModal();
                    loadCategories();
                    alert(id ? 'åˆ†ç±»æ›´æ–°æˆåŠŸï¼' : 'åˆ†ç±»åˆ›å»ºæˆåŠŸï¼');
                } else {
                    const error = await response.json();
                    alert('æ“ä½œå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ç½‘ç»œé”™è¯¯');
            }
        });

        // åˆ é™¤åˆ†ç±»
        async function deleteCategory(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±»"${name}"å—ï¼Ÿ\næ­¤æ“ä½œä¸ä¼šåˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„ç…§ç‰‡ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/categories/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadCategories();
                    alert('åˆ†ç±»åˆ é™¤æˆåŠŸï¼');
                } else {
                    const error = await response.json();
                    alert('åˆ é™¤å¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ç½‘ç»œé”™è¯¯');
            }
        }

        // åˆå§‹åŒ–
        loadCategories();
    </script>
</body>
</html>

