<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#3b82f6">
    <title>MYGallery - æˆ‘çš„ç…§ç‰‡å¢™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --bg:#f0f4f8;--bg2:#fff;--text:#1f2937;--text2:#6b7280;--glass:rgba(255,255,255,0.7);--glass-b:rgba(255,255,255,0.3);--accent:#3b82f6;--accent-l:rgba(59,130,246,0.1); }
        .dark-mode { --bg:#0f172a;--bg2:#1e293b;--text:#f1f5f9;--text2:#94a3b8;--glass:rgba(30,41,59,0.8);--glass-b:rgba(255,255,255,0.08);--accent:#60a5fa;--accent-l:rgba(96,165,250,0.15); }
        *{box-sizing:border-box} body{background:var(--bg);color:var(--text);transition:background .4s,color .3s;min-height:100vh;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;-webkit-font-smoothing:antialiased;margin:0}
        .dark-mode .text-gray-800,.dark-mode h1,.dark-mode h2,.dark-mode h3,.dark-mode p{color:var(--text)!important} .dark-mode .text-gray-600,.dark-mode .text-gray-700,.dark-mode .text-gray-500{color:var(--text2)!important}
        .glass-nav{background:var(--glass);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-bottom:1px solid var(--glass-b)}
        .photo-card{break-inside:avoid;margin-bottom:16px;position:relative}
        .card-inner{position:relative;overflow:hidden;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.08);transition:transform .3s cubic-bezier(.4,0,.2,1),box-shadow .3s;background:var(--bg2);cursor:pointer}
        .card-inner:hover{transform:translateY(-4px);box-shadow:0 12px 40px rgba(0,0,0,.15)}
        .photo-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,.75),rgba(0,0,0,.3) 60%,transparent);padding:40px 16px 16px;color:#fff;opacity:0;transition:opacity .3s} .card-inner:hover .photo-overlay,.touch-active .photo-overlay{opacity:1}
        .card-inner img{transition:transform .5s cubic-bezier(.4,0,.2,1);display:block} .card-inner:hover img{transform:scale(1.05)}
        .masonry{column-count:4;column-gap:16px;padding:0 4px} @media(max-width:1200px){.masonry{column-count:3}} @media(max-width:768px){.masonry{column-count:2;column-gap:10px}}
        .lazy-img{opacity:0;transition:opacity .5s} .lazy-loaded{opacity:1}
        .cat-btn{background:var(--accent-l);border:1.5px solid transparent;color:var(--text);font-weight:500;font-size:14px;padding:8px 20px;border-radius:999px;transition:all .25s;white-space:nowrap;cursor:pointer;-webkit-tap-highlight-color:transparent}
        .cat-btn:hover{background:var(--accent);color:#fff} .cat-btn.active{background:var(--accent);color:#fff;box-shadow:0 4px 14px rgba(59,130,246,.4)}
        .live-badge{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);color:#fff;font-size:11px;font-weight:600;padding:3px 8px;border-radius:6px;display:flex;align-items:center;gap:4px;z-index:5}
        .scroll-top{position:fixed;bottom:24px;right:24px;width:48px;height:48px;background:var(--accent);color:#fff;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;box-shadow:0 4px 20px rgba(59,130,246,.4);opacity:0;transform:translateY(20px);transition:all .3s;z-index:40} .scroll-top.visible{opacity:1;transform:translateY(0)}
        .mobile-menu-btn{display:none;padding:8px;cursor:pointer} @media(max-width:768px){.mobile-menu-btn{display:flex;align-items:center}.desktop-nav{display:none!important}.mobile-nav{position:fixed;top:64px;left:0;right:0;background:var(--glass);backdrop-filter:blur(20px);border-bottom:1px solid var(--glass-b);padding:16px 24px;z-index:45;transform:translateY(-100%);opacity:0;transition:all .3s}.mobile-nav.open{transform:translateY(0);opacity:1}.hero-title{font-size:1.75rem!important}.photo-card{margin-bottom:10px}.card-inner{border-radius:12px}}

        /* === Custom Viewer (ChronoFrame-style) === */
        .viewer-overlay{position:fixed;inset:0;z-index:100;display:none;opacity:0;transition:opacity .3s}
        .viewer-overlay.open{display:flex;opacity:1}
        .viewer-bg{position:absolute;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px)}
        .viewer-container{position:relative;z-index:1;display:flex;width:100%;height:100%}
        .viewer-main{flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-width:0}
        .viewer-img-wrap{max-width:100%;max-height:100%;padding:48px 60px 100px;display:flex;align-items:center;justify-content:center}
        .viewer-img-wrap img{max-width:100%;max-height:calc(100vh - 150px);object-fit:contain;border-radius:4px;user-select:none}

        /* Thumbnail strip */
        .thumb-strip{position:absolute;bottom:0;left:0;right:0;height:80px;display:flex;align-items:center;justify-content:center;gap:6px;padding:12px 60px;overflow-x:auto;z-index:6;background:linear-gradient(to top,rgba(0,0,0,.6),transparent);-webkit-overflow-scrolling:touch;scrollbar-width:none}
        .thumb-strip::-webkit-scrollbar{display:none}
        .thumb-item{flex-shrink:0;width:56px;height:56px;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid transparent;opacity:.5;transition:all .25s ease;position:relative}
        .thumb-item:hover{opacity:.8;transform:scale(1.05)}
        .thumb-item.active{opacity:1;border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,.4);transform:scale(1.1)}
        .thumb-item img{width:100%;height:100%;object-fit:cover;display:block}
        .viewer-nav{position:absolute;top:50%;transform:translateY(-50%);width:44px;height:44px;background:rgba(255,255,255,.1);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;font-size:20px;transition:all .2s;z-index:5} .viewer-nav:hover{background:rgba(255,255,255,.25)}
        .viewer-prev{left:16px} .viewer-next{right:16px}
        .viewer-close{position:absolute;top:16px;left:16px;z-index:10;width:40px;height:40px;background:rgba(255,255,255,.1);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;font-size:18px;transition:all .2s} .viewer-close:hover{background:rgba(255,255,255,.25)}
        .viewer-counter{position:absolute;top:16px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,.6);font-size:14px;font-weight:500;z-index:5}
        .viewer-info-btn{position:absolute;top:16px;right:16px;z-index:10;width:40px;height:40px;background:rgba(255,255,255,.1);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;font-size:16px;transition:all .2s} .viewer-info-btn:hover{background:rgba(255,255,255,.25)} .viewer-info-btn.active{background:var(--accent);border-color:var(--accent)}

        /* Info Panel (ChronoFrame-style side panel) */
        .info-panel{width:0;background:rgba(0,0,0,.3);backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);border-left:1px solid transparent;color:#fff;overflow:hidden;transition:width .35s cubic-bezier(.4,0,.2,1),border-color .35s;flex-shrink:0}
        .info-panel.open{width:340px;overflow-y:auto;border-left-color:rgba(255,255,255,.08)}
        .info-panel::-webkit-scrollbar{width:4px} .info-panel::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:2px}
        .info-section{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.06)}
        .info-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.4);margin-bottom:12px}
        .info-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;font-size:13px}
        .info-label{color:rgba(255,255,255,.5);display:flex;align-items:center;gap:6px;flex-shrink:0}
        .info-value{color:#fff;text-align:right;word-break:break-word;max-width:60%}
        .info-tag{display:inline-block;padding:3px 10px;background:rgba(255,255,255,.08);border-radius:6px;font-size:12px;margin:2px;color:rgba(255,255,255,.8)}
        #info-minimap{height:160px;border-radius:10px;overflow:hidden;margin:0 20px 16px}
        @media(max-width:768px){
            .info-panel{position:fixed;bottom:0;left:0;right:0;width:100%!important;max-height:70vh;border-left:none!important;border-top:1px solid transparent;border-radius:16px 16px 0 0;overflow:hidden;height:0;transition:height .35s cubic-bezier(.4,0,.2,1),border-color .35s}.info-panel.open{height:70vh;overflow-y:auto;border-top-color:rgba(255,255,255,.1)}
            .viewer-img-wrap{padding:16px 16px 88px}
            .viewer-img-wrap img{max-height:calc(100vh - 140px)}
            .thumb-strip{padding:10px 16px;height:72px}
            .thumb-item{width:48px;height:48px;border-radius:6px}
            .viewer-prev{left:8px;width:36px;height:36px} .viewer-next{right:8px;width:36px;height:36px}
        }
        footer{color:var(--text2)}
    </style>
</head>
<body>
    <header class="glass-nav fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 sm:py-4">
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center space-x-2 no-underline"><span class="text-2xl sm:text-3xl">ğŸ“·</span><h1 class="text-xl sm:text-2xl font-bold text-gray-800">MYGallery</h1></a>
                <nav class="desktop-nav flex items-center space-x-4">
                    <a href="/map.html" class="text-gray-700 hover:text-blue-600 transition font-medium text-sm flex items-center gap-1">ğŸ—ºï¸ åœ°å›¾</a>
                    <a href="/admin" class="text-gray-700 hover:text-blue-600 transition font-medium text-sm">ç®¡ç†</a>
                    <button id="theme-toggle" class="p-2 rounded-xl hover:bg-gray-200/50 transition" title="åˆ‡æ¢ä¸»é¢˜"><span class="text-xl">ğŸŒ™</span></button>
                </nav>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="èœå•"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg></button>
            </div>
        </div>
    </header>
    <div id="mobile-nav" class="mobile-nav"><div class="flex flex-col space-y-3">
        <a href="/map.html" class="text-gray-700 font-medium flex items-center gap-2">ğŸ—ºï¸ ç…§ç‰‡åœ°å›¾</a>
        <a href="/admin" class="text-gray-700 font-medium flex items-center gap-2">âš™ï¸ åå°ç®¡ç†</a>
        <button onclick="toggleTheme()" class="text-left text-gray-700 font-medium flex items-center gap-2"><span id="mobile-theme-icon">ğŸŒ™</span> åˆ‡æ¢ä¸»é¢˜</button>
    </div></div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 pt-20 sm:pt-24 pb-12">
        <div class="text-center mb-6 sm:mb-8">
            <h2 class="hero-title text-3xl sm:text-4xl font-bold text-gray-800 mb-2">ç²¾é€‰æ—¶åˆ» Â· ç¾å¥½å›å¿†</h2>
            <p class="text-gray-600 text-sm sm:text-base" id="photo-count">å…± 0 å¼ ç…§ç‰‡</p>
        </div>
        <div class="mb-6 sm:mb-8">
            <div class="flex flex-nowrap items-center justify-start sm:justify-center gap-2 sm:gap-3 mb-4 overflow-x-auto pb-2 px-1" id="category-filter" style="-webkit-overflow-scrolling:touch;scrollbar-width:none"><button onclick="filterByCategory('')" class="cat-btn active">å…¨éƒ¨</button></div>
            <div class="flex justify-center"><div class="relative w-full max-w-2xl">
                <button id="search-toggle" onclick="toggleSearch()" class="cat-btn flex items-center gap-2">ğŸ” æœç´¢ç…§ç‰‡</button>
                <div id="search-bar" class="hidden mt-3 rounded-2xl p-4 shadow-lg" style="background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--glass-b)">
                    <div class="relative"><input type="text" id="search-input" placeholder="æœç´¢æ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€ä½ç½®..." class="w-full px-4 py-3 pr-24 border-0 rounded-xl outline-none text-sm" style="background:var(--bg2);color:var(--text)" onkeyup="handleSearch(event)">
                    <div class="absolute right-2 top-1/2 -translate-y-1/2 flex space-x-2"><button onclick="performSearch()" class="px-4 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">æœç´¢</button><button onclick="clearSearch()" class="px-3 py-1.5 text-sm rounded-lg" style="background:var(--accent-l);color:var(--text)">æ¸…é™¤</button></div></div>
                </div>
            </div></div>
        </div>
        <div id="loading" class="flex justify-center items-center py-20"><div class="animate-spin rounded-full h-12 w-12 border-[3px] border-blue-200 border-t-blue-600"></div></div>
        <div id="photo-wall" class="masonry hidden"></div>
        <div id="empty-state" class="hidden text-center py-20"><div class="text-6xl mb-4">ğŸ“¸</div><h3 class="text-2xl font-semibold text-gray-700 mb-2">è¿˜æ²¡æœ‰ç…§ç‰‡</h3><p class="text-gray-500">æ•¬è¯·æœŸå¾…æ›´å¤šç²¾å½©ç…§ç‰‡</p></div>
        <div id="load-more" class="hidden text-center mt-8"><button onclick="loadMore()" class="px-8 py-3 rounded-xl font-medium" style="background:var(--bg2);box-shadow:0 2px 12px rgba(0,0,0,.08);color:var(--text)">åŠ è½½æ›´å¤š</button></div>
    </main>
    <footer class="text-center py-8"><p class="text-sm">Â© <script>document.write(new Date().getFullYear())</script> MYGallery</p></footer>
    <button class="scroll-top" id="scroll-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">â†‘</button>

    <!-- Custom Photo Viewer (ChronoFrame-style) -->
    <div class="viewer-overlay" id="viewer">
        <div class="viewer-bg" onclick="closeViewer()"></div>
        <div class="viewer-container">
            <div class="viewer-main">
                <div class="viewer-close" onclick="closeViewer()">âœ•</div>
                <div class="viewer-counter" id="viewer-counter">1 / 8</div>
                <div class="viewer-info-btn" id="viewer-info-btn" onclick="toggleInfoPanel()">â„¹</div>
                <div class="viewer-nav viewer-prev" onclick="viewerPrev()">â€¹</div>
                <div class="viewer-nav viewer-next" onclick="viewerNext()">â€º</div>
                <div class="viewer-img-wrap"><img id="viewer-img" src="" alt="" draggable="false"></div>
                <div class="thumb-strip" id="thumb-strip"></div>
            </div>
            <div class="info-panel" id="info-panel">
                <div class="info-section" style="border-bottom:1px solid rgba(255,255,255,.1)">
                    <div class="flex items-center justify-between">
                        <h3 id="info-title" class="font-bold text-lg" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></h3>
                        <button onclick="toggleInfoPanel()" class="ml-2 text-white/50 hover:text-white text-lg md:hidden" style="background:none;border:none;cursor:pointer">âœ•</button>
                    </div>
                    <p id="info-desc" class="text-sm text-white/70 mt-1"></p>
                </div>
                <div id="info-minimap" class="hidden"></div>
                <div id="info-sections"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    const API='/api';let curPage=1,total=0,loading=false,allPhotos=[],curCat='',curSearch='',viewerIdx=0,viewerPhotos=[],infoPanelOpen=false,miniMap=null;
    const isTouch='ontouchstart'in window;

    // Theme
    function initTheme(){const s=localStorage.getItem('theme')||'light';if(s==='dark')applyDark(true);document.getElementById('theme-toggle')?.addEventListener('click',()=>toggleTheme())}
    function toggleTheme(){const d=document.body.classList.toggle('dark-mode');localStorage.setItem('theme',d?'dark':'light');applyDark(d)}
    function applyDark(d){if(d)document.body.classList.add('dark-mode');const i=d?'â˜€ï¸':'ğŸŒ™';const t=document.querySelector('#theme-toggle span');if(t)t.textContent=i;const m=document.getElementById('mobile-theme-icon');if(m)m.textContent=i}
    function toggleMobileMenu(){document.getElementById('mobile-nav').classList.toggle('open')}
    window.addEventListener('scroll',()=>{document.getElementById('scroll-top').classList.toggle('visible',window.scrollY>400)});

    // Categories & Search
    async function loadCats(){try{const r=await fetch(`${API}/categories`);const c=await r.json();document.getElementById('category-filter').innerHTML='<button onclick="filterByCategory(\'\')" class="cat-btn active">å…¨éƒ¨</button>'+c.map(x=>`<button onclick="filterByCategory('${x.name}')" class="cat-btn" data-cat="${x.name}">${x.name}</button>`).join('')}catch(e){}}
    function filterByCategory(c){curCat=c;curPage=1;document.querySelectorAll('.cat-btn').forEach(b=>{b.classList.toggle('active',(c===''&&b.textContent.includes('å…¨éƒ¨'))||b.dataset.cat===c)});loadPhotos(1)}
    function toggleSearch(){const b=document.getElementById('search-bar');b.classList.toggle('hidden');if(!b.classList.contains('hidden'))document.getElementById('search-input').focus()}
    let sTimer;function handleSearch(e){if(e.key==='Enter'){performSearch();return}clearTimeout(sTimer);sTimer=setTimeout(()=>{if(document.getElementById('search-input').value.trim().length>0)performSearch()},300)}
    function performSearch(){clearTimeout(sTimer);curSearch=document.getElementById('search-input').value.trim();curPage=1;loadPhotos(1)}
    function clearSearch(){document.getElementById('search-input').value='';curSearch='';loadPhotos(1)}

    // Photos
    async function loadPhotos(page=1){if(loading)return;loading=true;try{let u=`${API}/photos?page=${page}&size=20`;if(curCat)u+=`&category=${encodeURIComponent(curCat)}`;if(curSearch)u+=`&search=${encodeURIComponent(curSearch)}`;const r=await fetch(u);if(!r.ok)throw new Error(`HTTP ${r.status}`);const d=await r.json();total=d.total;document.getElementById('photo-count').textContent=curCat?`${curCat}: ${total} å¼ ç…§ç‰‡`:curSearch?`æœç´¢: ${total} å¼ ç…§ç‰‡`:`å…± ${total} å¼ ç…§ç‰‡`;
    if(d.photos?.length>0){allPhotos=page===1?d.photos:[...allPhotos,...d.photos];renderPhotos(d.photos,page===1);document.getElementById('photo-wall').classList.remove('hidden');document.getElementById('loading').classList.add('hidden');document.getElementById('empty-state').classList.add('hidden');document.getElementById('load-more').classList.toggle('hidden',!(d.photos.length===20&&d.total>page*20))}else if(page===1){document.getElementById('empty-state').classList.remove('hidden');document.getElementById('loading').classList.add('hidden');document.getElementById('photo-wall').classList.add('hidden')}}catch(e){document.getElementById('loading').innerHTML=`<div class="text-center py-12"><p class="text-red-500 mb-4">åŠ è½½å¤±è´¥</p><button onclick="loadPhotos(1)" class="px-6 py-3 bg-blue-600 text-white rounded-xl">é‡è¯•</button></div>`}finally{loading=false}}
    function renderPhotos(photos,replace){const w=document.getElementById('photo-wall');if(replace)w.innerHTML='';const f=document.createDocumentFragment();photos.forEach(p=>f.appendChild(mkCard(p)));w.appendChild(f);initLazy()}
    function mkCard(p){const c=document.createElement('div');c.className='photo-card';const exif=[];if(p.camera_model)exif.push(p.camera_model);if(p.aperture)exif.push(p.aperture);if(p.shutter_speed)exif.push(p.shutter_speed);if(p.iso)exif.push('ISO '+p.iso);
    const img=p.url?.startsWith('http')?p.url:`/uploads/${p.filename}`,thumb=p.thumbnail_url||img;
    c.innerHTML=`<div class="card-inner" onclick="openViewer(${p.id})">${p.is_live_photo?'<div class="live-badge">LIVE</div>':''}<img data-src="${thumb}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect fill='%23e2e8f0' width='400' height='300'/%3E%3C/svg%3E" alt="${p.title||p.original_name}" class="w-full h-auto lazy-img" loading="lazy" onerror="this.src='${img}'"><div class="photo-overlay"><h3 class="font-semibold text-base mb-1">${p.title||p.original_name}</h3>${p.description?`<p class="text-sm text-gray-200 mb-1" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${p.description}</p>`:''}${exif.length?`<p class="text-xs text-gray-300 opacity-80">${exif.join(' Â· ')}</p>`:''}${p.location?`<p class="text-xs text-gray-300 mt-1 opacity-80">ğŸ“ ${p.location}</p>`:''}</div></div>`;
    if(isTouch){const inner=c.querySelector('.card-inner');inner.addEventListener('touchstart',function(){c.classList.add('touch-active')});inner.addEventListener('touchend',function(){setTimeout(()=>c.classList.remove('touch-active'),1500)})}
    return c}
    function loadMore(){curPage++;loadPhotos(curPage)}
    let lazyObs;function initLazy(){if(!lazyObs)lazyObs=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting&&e.target.dataset.src){e.target.src=e.target.dataset.src;e.target.classList.remove('lazy-img');e.target.classList.add('lazy-loaded');lazyObs.unobserve(e.target)}})},{rootMargin:'100px'});document.querySelectorAll('.lazy-img').forEach(i=>lazyObs.observe(i))}
    let scrollT;window.addEventListener('scroll',()=>{if(scrollT)return;scrollT=setTimeout(()=>{scrollT=null;if(window.innerHeight+window.scrollY>=document.body.offsetHeight-500&&!loading){const b=document.getElementById('load-more');if(!b.classList.contains('hidden'))loadMore()}},100)});

    // === Custom Viewer ===
    function openViewer(id){viewerPhotos=allPhotos;viewerIdx=allPhotos.findIndex(p=>p.id===id);if(viewerIdx<0)viewerIdx=0;buildThumbStrip();showViewerPhoto();document.getElementById('viewer').classList.add('open');document.body.style.overflow='hidden';infoPanelOpen=window.innerWidth>=768;if(infoPanelOpen){document.getElementById('info-panel').classList.add('open');document.getElementById('viewer-info-btn').classList.add('active')}}
    function closeViewer(){document.getElementById('viewer').classList.remove('open');document.body.style.overflow='';document.getElementById('info-panel').classList.remove('open');document.getElementById('viewer-info-btn').classList.remove('active');infoPanelOpen=false;if(miniMap){miniMap.remove();miniMap=null}}
    function viewerPrev(){if(viewerPhotos.length<2)return;viewerIdx=(viewerIdx-1+viewerPhotos.length)%viewerPhotos.length;showViewerPhoto()}
    function viewerNext(){if(viewerPhotos.length<2)return;viewerIdx=(viewerIdx+1)%viewerPhotos.length;showViewerPhoto()}
    function toggleInfoPanel(){infoPanelOpen=!infoPanelOpen;document.getElementById('info-panel').classList.toggle('open',infoPanelOpen);document.getElementById('viewer-info-btn').classList.toggle('active',infoPanelOpen)}
    document.addEventListener('keydown',e=>{if(!document.getElementById('viewer').classList.contains('open'))return;if(e.key==='Escape')closeViewer();if(e.key==='ArrowLeft')viewerPrev();if(e.key==='ArrowRight')viewerNext();if(e.key==='i'||e.key==='I')toggleInfoPanel()});

    function buildThumbStrip(){const strip=document.getElementById('thumb-strip');strip.innerHTML=viewerPhotos.map((p,i)=>{const t=p.thumbnail_url||(p.url?.startsWith('http')?p.url:`/uploads/${p.filename}`);return`<div class="thumb-item${i===viewerIdx?' active':''}" onclick="jumpToPhoto(${i})" title="${p.title||p.original_name}"><img src="${t}" alt="" onerror="this.src='${p.url||''}'"></div>`}).join('')}

    function jumpToPhoto(idx){viewerIdx=idx;showViewerPhoto()}

    function showViewerPhoto(){const p=viewerPhotos[viewerIdx];if(!p)return;
    const img=document.getElementById('viewer-img');img.src=p.url?.startsWith('http')?p.url:`/uploads/${p.filename}`;img.alt=p.title||p.original_name;
    document.getElementById('viewer-counter').textContent=`${viewerIdx+1} / ${viewerPhotos.length}`;
    document.getElementById('info-title').textContent=p.title||p.original_name;
    document.getElementById('info-desc').textContent=p.description||'';
    document.getElementById('info-desc').style.display=p.description?'':'none';
    // Update thumbnail active state
    document.querySelectorAll('.thumb-item').forEach((t,i)=>{t.classList.toggle('active',i===viewerIdx)});
    const activeThumb=document.querySelector('.thumb-item.active');if(activeThumb)activeThumb.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
    buildInfoSections(p);buildMiniMap(p)}

    function buildInfoSections(p){
    let h='';
    // Basic Info
    const basic=[];
    if(p.original_name)basic.push(r('ğŸ“„','æ–‡ä»¶å',p.original_name));
    if(p.file_size)basic.push(r('ğŸ’¾','æ–‡ä»¶å¤§å°',fmtBytes(p.file_size)));
    if(p.width&&p.height){basic.push(r('ğŸ“','åˆ†è¾¨ç‡',`${p.width} Ã— ${p.height}`));basic.push(r('ğŸ”²','åƒç´ ',`${(p.width*p.height/1e6).toFixed(2)} MP`))}
    if(p.date_taken)basic.push(r('ğŸ“…','æ‹æ‘„æ—¥æœŸ',new Date(p.date_taken).toLocaleString('zh-CN')));
    if(p.color_space)basic.push(r('ğŸ¨','è‰²å½©ç©ºé—´',p.color_space));
    if(p.software)basic.push(r('ğŸ“±','è½¯ä»¶',p.software));
    if(p.location)basic.push(r('ğŸ“','ä½ç½®',p.location));
    if(p.gps_latitude&&p.gps_longitude)basic.push(r('ğŸŒ','GPS',fmtGPS(p.gps_latitude,p.gps_longitude)));
    if(basic.length)h+=sec('åŸºæœ¬ä¿¡æ¯',basic.join(''));

    // Capture Parameters
    const cap=[];
    if(p.focal_length)cap.push(r('ğŸ”­','ç„¦è·',p.focal_length));
    if(p.aperture)cap.push(r('â­•','å…‰åœˆ',p.aperture));
    if(p.shutter_speed)cap.push(r('â±ï¸','å¿«é—¨',p.shutter_speed));
    if(p.iso)cap.push(r('â˜€ï¸','ISO',p.iso));
    if(p.exposure_bias)cap.push(r('Â±','æ›å…‰è¡¥å¿',p.exposure_bias));
    if(cap.length)h+=sec('æ‹æ‘„å‚æ•°',cap.join(''));

    // Device Info
    const dev=[];
    if(p.camera_make||p.camera_model)dev.push(r('ğŸ“·','ç›¸æœº',[p.camera_make,p.camera_model].filter(Boolean).join(' ')));
    if(p.lens_model)dev.push(r('ğŸ”','é•œå¤´',p.lens_model));
    if(dev.length)h+=sec('è®¾å¤‡ä¿¡æ¯',dev.join(''));

    // Shooting Mode
    const mode=[];
    if(p.white_balance)mode.push(r('ğŸŒ¡ï¸','ç™½å¹³è¡¡',p.white_balance));
    if(p.exposure_mode)mode.push(r('ğŸ“¸','æ›å…‰æ¨¡å¼',p.exposure_mode));
    if(p.metering_mode)mode.push(r('ğŸ¯','æµ‹å…‰æ¨¡å¼',p.metering_mode));
    if(p.flash)mode.push(r('âš¡','é—ªå…‰ç¯',p.flash));
    if(p.scene_type)mode.push(r('ğŸï¸','åœºæ™¯ç±»å‹',p.scene_type));
    if(mode.length)h+=sec('æ‹æ‘„æ¨¡å¼',mode.join(''));

    // Tags & Category
    const meta=[];
    if(p.category)meta.push(`<div style="margin-bottom:8px"><span class="info-tag">ğŸ“ ${p.category}</span></div>`);
    if(p.tags)meta.push(`<div class="flex flex-wrap">${p.tags.split(',').map(t=>`<span class="info-tag">${t.trim()}</span>`).join('')}</div>`);
    if(p.is_live_photo)meta.push(`<div style="margin-top:8px"><span class="info-tag" style="background:rgba(244,63,94,.3)">â— LIVE PHOTO</span></div>`);
    if(meta.length)h+=sec('æ ‡ç­¾ä¸åˆ†ç±»',meta.join(''));

    document.getElementById('info-sections').innerHTML=h}

    function sec(title,content){return`<div class="info-section"><div class="info-section-title">${title}</div>${content}</div>`}
    function r(icon,label,value){return`<div class="info-row"><span class="info-label">${icon} ${label}</span><span class="info-value">${value}</span></div>`}
    function fmtBytes(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(2)+' MB'}
    function fmtGPS(lat,lng){const ld=lat>=0?'N':'S',ld2=lng>=0?'E':'W';return`${Math.abs(lat).toFixed(4)}Â°${ld}, ${Math.abs(lng).toFixed(4)}Â°${ld2}`}

    function buildMiniMap(p){const el=document.getElementById('info-minimap');if(miniMap){miniMap.remove();miniMap=null}
    if(p.gps_latitude&&p.gps_longitude){el.classList.remove('hidden');setTimeout(()=>{miniMap=L.map(el,{zoomControl:false,attributionControl:false,dragging:false,scrollWheelZoom:false}).setView([p.gps_latitude,p.gps_longitude],13);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);L.marker([p.gps_latitude,p.gps_longitude]).addTo(miniMap);miniMap.invalidateSize()},100)}else{el.classList.add('hidden')}}

    // Touch swipe for viewer
    let touchStartX=0;document.getElementById('viewer')?.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX},{passive:true});
    document.getElementById('viewer')?.addEventListener('touchend',e=>{const diff=e.changedTouches[0].clientX-touchStartX;if(Math.abs(diff)>50){diff>0?viewerPrev():viewerNext()}},{passive:true});

    document.addEventListener('DOMContentLoaded',()=>{initTheme();loadCats();loadPhotos(1)});
    </script>
</body>
</html>
