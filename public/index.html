<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MYGallery - ÊàëÁöÑÁÖßÁâáÂ¢ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root{--bg:#fafafa;--bg2:#fff;--text:#171717;--text2:#a3a3a3;--glass:rgba(255,255,255,.72);--glass-b:rgba(0,0,0,.06);--accent:#a3a3a3;--accent-l:rgba(163,163,163,.1)}
        .dark-mode{--bg:#0a0a0a;--bg2:#171717;--text:#e5e5e5;--text2:#525252;--glass:rgba(23,23,23,.85);--glass-b:rgba(255,255,255,.06);--accent:#737373;--accent-l:rgba(115,115,115,.12)}
        *{box-sizing:border-box;margin:0;padding:0}
        body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',system-ui,sans-serif;-webkit-font-smoothing:antialiased;min-height:100vh;transition:background .4s,color .3s}
        .dark-mode .t-dark{color:var(--text)!important} .dark-mode .t2-dark{color:var(--text2)!important}

        /* Side nav */
        .side-nav{position:fixed;left:0;top:0;bottom:0;width:56px;z-index:50;display:flex;flex-direction:column;align-items:center;padding:16px 0;gap:4px;background:var(--glass);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-right:1px solid var(--glass-b)}
        .nav-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:var(--text2);text-decoration:none;font-size:18px;transition:all .2s;cursor:pointer;border:none;background:none;-webkit-tap-highlight-color:transparent}
        .nav-icon:hover{background:var(--accent-l);color:var(--accent)} .nav-icon.active{background:var(--accent);color:#fff}
        .nav-spacer{flex:1}
        @media(max-width:768px){.side-nav{left:0;right:0;top:auto;bottom:0;width:100%;height:52px;flex-direction:row;justify-content:center;padding:0 8px;gap:2px;border-right:none;border-top:1px solid var(--glass-b)}.nav-icon{width:44px;height:44px}.nav-spacer{display:none}}

        /* Main content */
        .main-content{margin-left:56px;min-height:100vh} @media(max-width:768px){.main-content{margin-left:0;margin-bottom:52px}}

        /* Header bar */
        .header-bar{padding:12px 20px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:30;background:var(--glass);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-bottom:1px solid var(--glass-b)}
        .header-bar h1{font-size:16px;font-weight:700;white-space:nowrap}
        .header-bar .count{font-size:12px;color:var(--text2);white-space:nowrap}

        /* Category & search */
        .filter-bar{padding:8px 20px;display:flex;align-items:center;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;border-bottom:1px solid var(--glass-b);background:var(--bg)}
        .filter-bar::-webkit-scrollbar{display:none}
        .cat-btn{background:var(--accent-l);border:none;color:var(--text);font-weight:500;font-size:12px;padding:6px 14px;border-radius:999px;cursor:pointer;white-space:nowrap;transition:all .2s;-webkit-tap-highlight-color:transparent}
        .cat-btn:hover{background:var(--text);color:var(--bg)} .cat-btn.active{background:var(--text);color:var(--bg)}
        .search-input{flex:1;min-width:120px;max-width:240px;padding:6px 12px;border-radius:8px;border:1px solid var(--glass-b);background:var(--bg2);color:var(--text);font-size:12px;outline:none;transition:border-color .2s}
        .search-input:focus{border-color:var(--accent)}

        /* Masonry grid - denser */
        .masonry{column-count:5;column-gap:4px;padding:4px}
        @media(max-width:1400px){.masonry{column-count:4}}
        @media(max-width:1000px){.masonry{column-count:3}}
        @media(max-width:600px){.masonry{column-count:2;column-gap:3px;padding:3px}}
        .photo-card{break-inside:avoid;margin-bottom:4px;position:relative}
        @media(max-width:600px){.photo-card{margin-bottom:3px}}
        .card-inner{position:relative;overflow:hidden;cursor:pointer;background:var(--bg2)}
        .card-inner img{display:block;width:100%;height:auto;transition:transform .4s cubic-bezier(.4,0,.2,1)} .card-inner:hover img{transform:scale(1.04)}
        .photo-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,.7),transparent);padding:28px 10px 10px;color:#fff;opacity:0;transition:opacity .3s} .card-inner:hover .photo-overlay,.touch-active .photo-overlay{opacity:1}
        .photo-overlay h3{font-size:13px;font-weight:600;line-height:1.3} .photo-overlay p{font-size:10px;opacity:.8;margin-top:2px}
        .live-badge{position:absolute;top:6px;left:6px;background:rgba(0,0,0,.5);backdrop-filter:blur(6px);color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;z-index:2}
        .lazy-img{opacity:0;transition:opacity .5s} .lazy-loaded{opacity:1}
        .scroll-top{position:fixed;bottom:24px;right:24px;width:40px;height:40px;background:var(--accent);color:#fff;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.15);opacity:0;transform:translateY(16px);transition:all .3s;z-index:40} .scroll-top.visible{opacity:1;transform:translateY(0)}
        @media(max-width:768px){.scroll-top{bottom:68px}}

        /* Viewer */
        .viewer-overlay{position:fixed;inset:0;z-index:100;display:none;opacity:0;transition:opacity .3s} .viewer-overlay.open{display:flex;opacity:1}
        .viewer-bg{position:absolute;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px)}
        .viewer-container{position:relative;z-index:1;display:flex;width:100%;height:100%}
        .viewer-main{flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-width:0}
        .viewer-img-wrap{max-width:100%;max-height:100%;padding:12px 56px 84px;display:flex;align-items:center;justify-content:center}
        .viewer-img-wrap img{max-width:100%;max-height:calc(100vh - 100px);object-fit:contain;border-radius:2px;user-select:none}
        .thumb-strip{position:absolute;bottom:0;left:0;right:0;height:72px;display:flex;align-items:center;justify-content:center;gap:4px;padding:10px 56px;overflow-x:auto;z-index:6;background:linear-gradient(to top,rgba(0,0,0,.5),transparent);-webkit-overflow-scrolling:touch;scrollbar-width:none}
        .thumb-strip::-webkit-scrollbar{display:none}
        .thumb-item{flex-shrink:0;width:52px;height:52px;border-radius:6px;overflow:hidden;cursor:pointer;border:2px solid transparent;opacity:.45;transition:all .2s}
        .thumb-item:hover{opacity:.75} .thumb-item.active{opacity:1;border-color:#fff;box-shadow:0 0 10px rgba(255,255,255,.35);transform:scale(1.08)}
        .thumb-item img{width:100%;height:100%;object-fit:cover;display:block}
        .vbtn{position:absolute;z-index:10;width:36px;height:36px;background:rgba(255,255,255,.08);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.12);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;transition:all .2s;font-size:16px} .vbtn:hover{background:rgba(255,255,255,.2)}
        .viewer-close{top:12px;left:12px;font-size:14px}
        .viewer-share{top:12px;right:56px} .viewer-share.copied{background:rgba(34,197,94,.6);border-color:rgba(34,197,94,.8)}
        .viewer-info-btn{top:12px;right:12px} .viewer-info-btn.active{background:var(--accent);border-color:var(--accent)}
        .viewer-nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;background:rgba(255,255,255,.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.1);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;font-size:18px;transition:all .2s;z-index:5} .viewer-nav:hover{background:rgba(255,255,255,.18)}
        .viewer-prev{left:12px} .viewer-next{right:12px}

        .info-panel{width:0;background:rgba(0,0,0,.25);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);border-left:1px solid transparent;color:#fff;overflow:hidden;transition:width .35s cubic-bezier(.4,0,.2,1),border-color .35s;flex-shrink:0}
        .info-panel.open{width:320px;overflow-y:auto;border-left-color:rgba(255,255,255,.06)}
        .info-panel::-webkit-scrollbar{width:3px} .info-panel::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px}
        .info-section{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.05)}
        .info-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.35);margin-bottom:10px}
        .info-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;font-size:12px}
        .info-label{color:rgba(255,255,255,.45);display:flex;align-items:center;gap:5px;flex-shrink:0} .info-value{color:#fff;text-align:right;word-break:break-word;max-width:58%}
        .info-tag{display:inline-block;padding:2px 8px;background:rgba(255,255,255,.07);border-radius:5px;font-size:11px;margin:2px;color:rgba(255,255,255,.75)}
        #info-minimap{height:140px;border-radius:8px;overflow:hidden;margin:0 16px 12px}
        /* Reaction picker */
        .reaction-picker{position:absolute;top:52px;right:80px;z-index:30;background:rgba(23,23,23,.92);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;box-shadow:0 16px 48px rgba(0,0,0,.4);animation:rpIn .2s ease}
        @keyframes rpIn{from{opacity:0;transform:scale(.92) translateY(-8px)}to{opacity:1;transform:scale(1) translateY(0)}}
        .reaction-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;min-width:200px}
        .reaction-item{position:relative;aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:12px;cursor:pointer;transition:all .15s;background:transparent;border:none;padding:4px;-webkit-tap-highlight-color:transparent}
        .reaction-item:hover{background:rgba(255,255,255,.08);transform:scale(1.12)}
        .reaction-item:active{transform:scale(.92)}
        .reaction-item.selected{background:rgba(59,130,246,.2);box-shadow:inset 0 0 0 2px rgba(59,130,246,.5)}
        .reaction-item .emoji{font-size:26px;line-height:1;pointer-events:none}
        .reaction-item .rcount{position:absolute;top:-2px;right:-2px;min-width:16px;height:16px;padding:0 4px;background:rgba(255,255,255,.12);border-radius:8px;font-size:9px;font-weight:700;color:rgba(255,255,255,.7);display:flex;align-items:center;justify-content:center}
        .reaction-item.selected .rcount{background:rgba(59,130,246,.6);color:#fff}
        .viewer-react.has-reaction{background:rgba(59,130,246,.3);border-color:rgba(59,130,246,.5)}
        @media(max-width:768px){.reaction-picker{right:30px;top:48px;padding:10px}.reaction-item .emoji{font-size:22px}.viewer-download{right:132px!important}.viewer-share{right:88px!important}.viewer-react{right:44px!important}}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(34,197,94,.9);color:#fff;padding:8px 20px;border-radius:10px;font-size:13px;font-weight:500;opacity:0;transition:all .3s;z-index:200;pointer-events:none;backdrop-filter:blur(8px)} .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        @media(max-width:768px){
            .info-panel{position:fixed;bottom:0;left:0;right:0;width:100%!important;max-height:70vh;border-left:none!important;border-top:1px solid transparent;border-radius:14px 14px 0 0;overflow:hidden;height:0;transition:height .35s cubic-bezier(.4,0,.2,1),border-color .35s}.info-panel.open{height:70vh;overflow-y:auto;border-top-color:rgba(255,255,255,.1)}
            .viewer-img-wrap{padding:8px 8px 80px} .viewer-img-wrap img{max-height:calc(100vh - 120px)}
            .thumb-strip{padding:8px 12px;height:64px} .thumb-item{width:44px;height:44px;border-radius:5px}
            .viewer-prev{left:6px;width:32px;height:32px} .viewer-next{right:6px;width:32px;height:32px}
            .viewer-share{right:50px} .viewer-info-btn{right:8px} .viewer-close{left:8px}
        }
        @media (max-width: 768px) {
            .mobile-menu-btn { display: flex; align-items: center; }
            .desktop-nav { display: none !important; }
            .mobile-nav {
                position: fixed; top: 64px; left: 0; right: 0;
                background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                border-bottom: 1px solid var(--glass-border);
                padding: 16px 24px; z-index: 45;
                transform: translateY(-100%); opacity: 0;
                transition: all 0.3s ease;
            }
            .mobile-nav.open { transform: translateY(0); opacity: 1; }
            .hero-title { font-size: 1.75rem !important; }
            .photo-card { margin-bottom: 10px; }
            .photo-card .card-inner { border-radius: 12px; }
            .photo-description { padding: 30px 12px 12px; }
            .photo-description h3 { font-size: 14px !important; }
            .photo-description p { font-size: 11px !important; }
        }

        footer { color: var(--text-secondary); }

        .exif-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; background: rgba(255,255,255,0.15); border-radius: 999px; font-size: 13px; backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <!-- Side navigation (ChronoFrame-style line icons) -->
    <nav class="side-nav">
        <a href="/" class="nav-icon active" title="È¶ñÈ°µ"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="14" height="14" rx="3"/><circle cx="7.5" cy="7.5" r="1.5"/><path d="M3 13l4-4a2 2 0 012.8 0L14 13"/><path d="M12 11l1-1a2 2 0 012.8 0L17 11"/></svg></a>
        <div class="nav-spacer"></div>
        <a href="/albums.html" class="nav-icon" title="Áõ∏ÂÜå"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="16" height="13" rx="2"/><path d="M2 9h16"/><path d="M9 4v5"/></svg></a>
        <a href="/map.html" class="nav-icon" title="Âú∞Âõæ"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7l5-3 4 3 5-3v12l-5 3-4-3-5 3z"/><path d="M8 4v12M12 7v12"/></svg></a>
        <a href="/admin" class="nav-icon" title="ÁÆ°ÁêÜ"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="6" height="6" rx="1"/><rect x="11" y="3" width="6" height="6" rx="1"/><rect x="3" y="11" width="6" height="6" rx="1"/><rect x="11" y="11" width="6" height="6" rx="1"/></svg></a>
        <button class="nav-icon" id="theme-toggle" title="‰∏ªÈ¢ò"><svg id="theme-icon" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="10" cy="10" r="4"/><path d="M10 2v2M10 16v2M2 10h2M16 10h2M4.93 4.93l1.41 1.41M13.66 13.66l1.41 1.41M4.93 15.07l1.41-1.41M13.66 6.34l1.41-1.41"/></svg></button>
    </nav>

    <div class="main-content">
        <!-- Compact header + filters -->
        <div class="header-bar">
            <h1 class="t-dark">MYGallery</h1>
            <span class="count" id="photo-count">0 Âº†ÁÖßÁâá</span>
            <div style="flex:1"></div>
            <div id="category-filter" style="display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch">
                <button onclick="filterByCategory('')" class="cat-btn active">ÂÖ®ÈÉ®</button>
            </div>
        </div>
        <div class="filter-bar" id="filter-bar" style="display:none">
            <input type="text" id="search-input" class="search-input" placeholder="ÊêúÁ¥¢Ê†áÈ¢ò„ÄÅÊèèËø∞„ÄÅÊ†áÁ≠æ„ÄÅ‰ΩçÁΩÆ..." onkeyup="handleSearch(event)">
            <button onclick="clearSearch()" class="cat-btn" style="font-size:11px">Ê∏ÖÈô§</button>
        </div>

        <!-- Gallery -->
        <div id="loading" style="display:flex;justify-content:center;padding:80px 0"><div class="animate-spin rounded-full" style="width:36px;height:36px;border:3px solid var(--glass-b);border-top-color:var(--accent);border-radius:50%"></div></div>
        <div id="photo-wall" class="masonry" style="display:none"></div>
        <div id="empty-state" style="display:none;text-align:center;padding:80px 20px"><div style="font-size:48px;margin-bottom:12px">üì∏</div><h3 style="font-size:18px;font-weight:600;color:var(--text);margin-bottom:6px">ËøòÊ≤°ÊúâÁÖßÁâá</h3><p style="font-size:13px;color:var(--text2)">Êï¨ËØ∑ÊúüÂæÖÊõ¥Â§öÁ≤æÂΩ©ÁÖßÁâá</p></div>
        <div id="load-more" style="display:none;text-align:center;padding:20px"><button onclick="loadMore()" class="cat-btn" style="padding:8px 24px">Âä†ËΩΩÊõ¥Â§ö</button></div>
    </div>
    <button class="scroll-top" id="scroll-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚Üë</button>

    <!-- Viewer -->
    <div class="viewer-overlay" id="viewer">
        <div class="viewer-bg" onclick="closeViewer()"></div>
        <div class="viewer-container">
            <div class="viewer-main">
                <div class="vbtn viewer-close" onclick="closeViewer()"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 4l8 8M12 4l-8 8"/></svg></div>
                <div class="vbtn viewer-download" id="viewer-download" onclick="downloadPhoto()" title="‰∏ãËΩΩÂéüÂõæ" style="top:12px;right:144px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v2a1 1 0 001 1h6a1 1 0 001-1v-2M8 12V2M5 9l3 3 3-3"/></svg></div>
                <div class="vbtn viewer-share" id="viewer-share" onclick="sharePhoto()" title="ÂàÜ‰∫´" style="top:12px;right:100px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v2a1 1 0 001 1h6a1 1 0 001-1v-2M8 2v9M5 5l3-3 3 3"/></svg></div>
                <div class="vbtn viewer-react" id="viewer-react" onclick="toggleReactionPicker()" title="Ë°®ÊÄÅ" style="top:12px;right:56px"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="7"/><path d="M5.5 6.5v.01M10.5 6.5v.01M5.5 10c.83.83 4.17.83 5 0"/></svg></div>
                <!-- Reaction picker popup -->
                <div class="reaction-picker" id="reaction-picker" style="display:none">
                    <div class="reaction-grid" id="reaction-grid"></div>
                </div>
                <div class="vbtn viewer-info-btn" id="viewer-info-btn" onclick="toggleInfoPanel()"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="8" cy="8" r="6"/><path d="M8 7v4M8 5.5v0"/></svg></div>
                <div class="viewer-nav viewer-prev" onclick="viewerPrev()"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3l-5 5 5 5"/></svg></div>
                <div class="viewer-nav viewer-next" onclick="viewerNext()"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3l5 5-5 5"/></svg></div>
                <div class="viewer-img-wrap"><img id="viewer-img" src="" alt="" draggable="false"></div>
                <div class="thumb-strip" id="thumb-strip"></div>
            </div>
            <div class="info-panel" id="info-panel">
                <div class="info-section" style="border-bottom:1px solid rgba(255,255,255,.08)">
                    <div style="display:flex;align-items:center;justify-content:space-between">
                        <h3 id="info-title" style="font-weight:700;font-size:15px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></h3>
                        <button onclick="toggleInfoPanel()" style="background:none;border:none;color:rgba(255,255,255,.4);cursor:pointer;font-size:16px;display:none" class="mobile-close-info">‚úï</button>
                    </div>
                    <p id="info-desc" style="font-size:12px;color:rgba(255,255,255,.6);margin-top:4px"></p>
                </div>
                <div id="info-minimap" style="display:none"></div>
                <div id="info-sections"></div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast">ÈìæÊé•Â∑≤Â§çÂà∂</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    const API='/api';let curPage=1,total=0,loading=false,allPhotos=[],curCat='',curSearch='',viewerIdx=0,viewerPhotos=[],infoPanelOpen=false,miniMap=null;
    const isTouch='ontouchstart'in window;

    // Theme
    function initTheme(){const s=localStorage.getItem('theme')||'dark';applyDark(s==='dark');document.getElementById('theme-toggle')?.addEventListener('click',()=>toggleTheme())}
    function toggleTheme(){const d=document.body.classList.toggle('dark-mode');localStorage.setItem('theme',d?'dark':'light');applyDark(d)}
    function applyDark(d){if(d)document.body.classList.add('dark-mode');else document.body.classList.remove('dark-mode');const icon=document.getElementById('theme-icon');if(icon)icon.innerHTML=d?'<circle cx="10" cy="10" r="4"/><path d="M10 2v2M10 16v2M2 10h2M16 10h2M4.93 4.93l1.41 1.41M13.66 13.66l1.41 1.41M4.93 15.07l1.41-1.41M13.66 6.34l1.41-1.41"/>':'<path d="M10 3a7 7 0 100 14 5 5 0 010-14z"/>'}
    window.addEventListener('scroll',()=>{document.getElementById('scroll-top').classList.toggle('visible',window.scrollY>300)});

    // Categories & Search
    async function loadCats(){try{const r=await fetch(`${API}/categories`);const c=await r.json();const el=document.getElementById('category-filter');el.innerHTML='<button onclick="filterByCategory(\'\')" class="cat-btn active">ÂÖ®ÈÉ®</button>'+c.map(x=>`<button onclick="filterByCategory('${x.name}')" class="cat-btn" data-cat="${x.name}">${x.name}</button>`).join('')+'<button onclick="toggleSearchBar()" class="cat-btn" style="opacity:.6">üîç</button>'}catch(e){}}
    function filterByCategory(c){curCat=c;curPage=1;document.querySelectorAll('.cat-btn').forEach(b=>{b.classList.toggle('active',(c===''&&b.textContent.includes('ÂÖ®ÈÉ®'))||b.dataset.cat===c)});loadPhotos(1)}
    function toggleSearchBar(){const fb=document.getElementById('filter-bar');fb.style.display=fb.style.display==='none'?'flex':'none';if(fb.style.display==='flex')document.getElementById('search-input').focus()}
    let sTimer;function handleSearch(e){if(e.key==='Enter'){performSearch();return}clearTimeout(sTimer);sTimer=setTimeout(()=>{if(document.getElementById('search-input').value.trim().length>0)performSearch()},300)}
    function performSearch(){clearTimeout(sTimer);curSearch=document.getElementById('search-input').value.trim();curPage=1;loadPhotos(1)}
    function clearSearch(){document.getElementById('search-input').value='';curSearch='';loadPhotos(1)}

    // Photos
    async function loadPhotos(page=1){if(loading)return;loading=true;try{let u=`${API}/photos?page=${page}&size=20`;if(curCat)u+=`&category=${encodeURIComponent(curCat)}`;if(curSearch)u+=`&search=${encodeURIComponent(curSearch)}`;const r=await fetch(u);if(!r.ok)throw new Error(`HTTP ${r.status}`);const d=await r.json();total=d.total;document.getElementById('photo-count').textContent=curCat?`${curCat} ¬∑ ${total}`:curSearch?`ÊêúÁ¥¢ ¬∑ ${total}`:`${total} Âº†ÁÖßÁâá`;
    if(d.photos?.length>0){allPhotos=page===1?d.photos:[...allPhotos,...d.photos];renderPhotos(d.photos,page===1);document.getElementById('photo-wall').style.display='';document.getElementById('loading').style.display='none';document.getElementById('empty-state').style.display='none';document.getElementById('load-more').style.display=(d.photos.length===20&&d.total>page*20)?'block':'none'}else if(page===1){document.getElementById('empty-state').style.display='block';document.getElementById('loading').style.display='none';document.getElementById('photo-wall').style.display='none'}}catch(e){document.getElementById('loading').innerHTML=`<div style="text-align:center;padding:40px"><p style="color:#ef4444;margin-bottom:12px">Âä†ËΩΩÂ§±Ë¥•</p><button onclick="loadPhotos(1)" class="cat-btn">ÈáçËØï</button></div>`}finally{loading=false}}

    function renderPhotos(photos,replace){const w=document.getElementById('photo-wall');if(replace)w.innerHTML='';const f=document.createDocumentFragment();photos.forEach(p=>f.appendChild(mkCard(p)));w.appendChild(f);initLazy()}
    function mkCard(p){const c=document.createElement('div');c.className='photo-card';
    const img=p.url?.startsWith('http')?p.url:`/uploads/${p.filename}`,thumb=p.thumbnail_url||img;
    const ar=p.width&&p.height?`${p.width}/${p.height}`:'4/3';
    c.innerHTML=`<div class="card-inner" onclick="openViewer(${p.id})" style="aspect-ratio:${ar};overflow:hidden">${p.is_live_photo?'<div class="live-badge">LIVE</div>':''}<img data-src="${thumb}" src="" alt="${p.title||p.original_name}" class="w-full h-full lazy-img" style="object-fit:cover" loading="lazy" onerror="this.src='${img}'"><div class="photo-overlay"><h3>${p.title||p.original_name}</h3>${p.location?`<p>üìç ${p.location}</p>`:''}</div></div>`;
    if(isTouch){const inner=c.querySelector('.card-inner');inner.addEventListener('touchstart',function(){c.classList.add('touch-active')});inner.addEventListener('touchend',function(){setTimeout(()=>c.classList.remove('touch-active'),1200)})}
    return c}
    function loadMore(){curPage++;loadPhotos(curPage)}
    let lazyObs;function initLazy(){if(!lazyObs)lazyObs=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting&&e.target.dataset.src){e.target.src=e.target.dataset.src;e.target.classList.remove('lazy-img');e.target.classList.add('lazy-loaded');lazyObs.unobserve(e.target)}})},{rootMargin:'200px'});document.querySelectorAll('.lazy-img').forEach(i=>lazyObs.observe(i))}
    let scrollT;window.addEventListener('scroll',()=>{if(scrollT)return;scrollT=setTimeout(()=>{scrollT=null;if(window.innerHeight+window.scrollY>=document.body.offsetHeight-500&&!loading){const b=document.getElementById('load-more');if(b.style.display!=='none')loadMore()}},100)});

    // === Viewer ===
    function openViewer(id){viewerPhotos=allPhotos;viewerIdx=allPhotos.findIndex(p=>p.id===id);if(viewerIdx<0)viewerIdx=0;buildThumbStrip();showViewerPhoto();document.getElementById('viewer').classList.add('open');document.body.style.overflow='hidden';infoPanelOpen=window.innerWidth>=768;if(infoPanelOpen){document.getElementById('info-panel').classList.add('open');document.getElementById('viewer-info-btn').classList.add('active')}
    updateURL(viewerPhotos[viewerIdx]?.id)}
    function closeViewer(){closeReactionPicker();document.getElementById('viewer').classList.remove('open');document.body.style.overflow='';document.getElementById('info-panel').classList.remove('open');document.getElementById('viewer-info-btn').classList.remove('active');infoPanelOpen=false;if(miniMap){miniMap.remove();miniMap=null}
    history.replaceState(null,'',window.location.pathname)}
    function viewerPrev(){if(viewerPhotos.length<2)return;viewerIdx=(viewerIdx-1+viewerPhotos.length)%viewerPhotos.length;showViewerPhoto();updateURL(viewerPhotos[viewerIdx]?.id)}
    function viewerNext(){if(viewerPhotos.length<2)return;viewerIdx=(viewerIdx+1)%viewerPhotos.length;showViewerPhoto();updateURL(viewerPhotos[viewerIdx]?.id)}
    function toggleInfoPanel(){infoPanelOpen=!infoPanelOpen;document.getElementById('info-panel').classList.toggle('open',infoPanelOpen);document.getElementById('viewer-info-btn').classList.toggle('active',infoPanelOpen)}
    document.addEventListener('keydown',e=>{if(!document.getElementById('viewer').classList.contains('open'))return;if(e.key==='Escape')closeViewer();if(e.key==='ArrowLeft')viewerPrev();if(e.key==='ArrowRight')viewerNext();if(e.key==='i'||e.key==='I')toggleInfoPanel()});

    function updateURL(photoId){if(photoId)history.replaceState(null,'',`?photo=${photoId}`)}

    function downloadPhoto(){const p=viewerPhotos[viewerIdx];if(!p)return;const url=p.url?.startsWith('http')?p.url:`/uploads/${p.filename}`;const a=document.createElement('a');a.href=url;a.download=p.original_name||p.filename||'photo.jpg';a.target='_blank';document.body.appendChild(a);a.click();document.body.removeChild(a)}

    function sharePhoto(){const p=viewerPhotos[viewerIdx];if(!p)return;const url=`${window.location.origin}?photo=${p.id}`;navigator.clipboard.writeText(url).then(()=>{showToast('ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');const btn=document.getElementById('viewer-share');btn.classList.add('copied');setTimeout(()=>btn.classList.remove('copied'),1500)}).catch(()=>{const ta=document.createElement('textarea');ta.value=url;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showToast('ÈìæÊé•Â∑≤Â§çÂà∂')})}
    function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}

    function buildThumbStrip(){const strip=document.getElementById('thumb-strip');strip.innerHTML=viewerPhotos.map((p,i)=>{const t=p.thumbnail_url||(p.url?.startsWith('http')?p.url:`/uploads/${p.filename}`);return`<div class="thumb-item${i===viewerIdx?' active':''}" onclick="jumpToPhoto(${i})"><img src="${t}" alt="" onerror="this.src='${p.url||''}'"></div>`}).join('')}
    function jumpToPhoto(idx){viewerIdx=idx;showViewerPhoto();updateURL(viewerPhotos[viewerIdx]?.id)}

    function showViewerPhoto(){const p=viewerPhotos[viewerIdx];if(!p)return;closeReactionPicker();currentReactionData={reactions:{},userReaction:null};updateReactBtn();loadReactionsQuiet();
    const img=document.getElementById('viewer-img');img.src=p.url?.startsWith('http')?p.url:`/uploads/${p.filename}`;img.alt=p.title||p.original_name;
    document.getElementById('info-title').textContent=p.title||p.original_name;
    document.getElementById('info-desc').textContent=p.description||'';
    document.getElementById('info-desc').style.display=p.description?'':'none';
    document.querySelectorAll('.thumb-item').forEach((t,i)=>{t.classList.toggle('active',i===viewerIdx)});
    const at=document.querySelector('.thumb-item.active');if(at)at.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
    buildInfoSections(p);buildMiniMap(p)}

    function buildInfoSections(p){let h='';
    const basic=[];if(p.original_name)basic.push(r('üìÑ','Êñá‰ª∂Âêç',p.original_name));if(p.file_size)basic.push(r('üíæ','Â§ßÂ∞è',fmtBytes(p.file_size)));if(p.width&&p.height){basic.push(r('üìê','ÂàÜËæ®Áéá',`${p.width}√ó${p.height}`));basic.push(r('üî≤','ÂÉèÁ¥†',`${(p.width*p.height/1e6).toFixed(1)} MP`))}if(p.date_taken)basic.push(r('üìÖ','Êó•Êúü',new Date(p.date_taken).toLocaleString('zh-CN')));if(p.color_space)basic.push(r('üé®','Ëâ≤ÂΩ©',p.color_space));if(p.software)basic.push(r('üì±','ËΩØ‰ª∂',p.software));if(p.location)basic.push(r('üìç','‰ΩçÁΩÆ',p.location));if(p.gps_latitude&&p.gps_longitude)basic.push(r('üåê','GPS',fmtGPS(p.gps_latitude,p.gps_longitude)));if(basic.length)h+=sec('Âü∫Êú¨‰ø°ÊÅØ',basic.join(''));
    const cap=[];if(p.focal_length)cap.push(r('üî≠','ÁÑ¶Ë∑ù',p.focal_length));if(p.aperture)cap.push(r('‚≠ï','ÂÖâÂúà',p.aperture));if(p.shutter_speed)cap.push(r('‚è±','Âø´Èó®',p.shutter_speed));if(p.iso)cap.push(r('‚òÄÔ∏è','ISO',p.iso));if(p.exposure_bias)cap.push(r('¬±','ÊõùÂÖâË°•ÂÅø',p.exposure_bias));if(cap.length)h+=sec('ÊãçÊëÑÂèÇÊï∞',cap.join(''));
    const dev=[];if(p.camera_make||p.camera_model)dev.push(r('üì∑','Áõ∏Êú∫',[p.camera_make,p.camera_model].filter(Boolean).join(' ')));if(p.lens_model)dev.push(r('üîç','ÈïúÂ§¥',p.lens_model));if(dev.length)h+=sec('ËÆæÂ§á‰ø°ÊÅØ',dev.join(''));
    const mode=[];if(p.white_balance)mode.push(r('üå°','ÁôΩÂπ≥Ë°°',p.white_balance));if(p.exposure_mode)mode.push(r('üì∏','ÊõùÂÖâ',p.exposure_mode));if(p.metering_mode)mode.push(r('üéØ','ÊµãÂÖâ',p.metering_mode));if(p.flash)mode.push(r('‚ö°','Èó™ÂÖâÁÅØ',p.flash));if(p.scene_type)mode.push(r('üèû','Âú∫ÊôØ',p.scene_type));if(mode.length)h+=sec('ÊãçÊëÑÊ®°Âºè',mode.join(''));
    const meta=[];if(p.category)meta.push(`<div style="margin-bottom:6px"><span class="info-tag">üìÅ ${p.category}</span></div>`);if(p.tags)meta.push(`<div style="display:flex;flex-wrap:wrap">${p.tags.split(',').map(t=>`<span class="info-tag">${t.trim()}</span>`).join('')}</div>`);if(p.is_live_photo)meta.push(`<div style="margin-top:6px"><span class="info-tag" style="background:rgba(244,63,94,.25)">‚óè LIVE</span></div>`);if(meta.length)h+=sec('Ê†áÁ≠æ',meta.join(''));
    document.getElementById('info-sections').innerHTML=h}
    function sec(t,c){return`<div class="info-section"><div class="info-section-title">${t}</div>${c}</div>`}
    function r(i,l,v){return`<div class="info-row"><span class="info-label">${i} ${l}</span><span class="info-value">${v}</span></div>`}
    function fmtBytes(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB'}
    function fmtGPS(la,ln){return`${Math.abs(la).toFixed(4)}¬∞${la>=0?'N':'S'}, ${Math.abs(ln).toFixed(4)}¬∞${ln>=0?'E':'W'}`}
    function buildMiniMap(p){const el=document.getElementById('info-minimap');if(miniMap){miniMap.remove();miniMap=null}if(p.gps_latitude&&p.gps_longitude){el.style.display='';setTimeout(()=>{miniMap=L.map(el,{zoomControl:false,attributionControl:false,dragging:false,scrollWheelZoom:false}).setView([p.gps_latitude,p.gps_longitude],13);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);L.marker([p.gps_latitude,p.gps_longitude]).addTo(miniMap);miniMap.invalidateSize()},100)}else{el.style.display='none'}}

    // === Reactions ===
    const REACTIONS=[
        {id:'like',emoji:'üëç',label:'Ëµû'},
        {id:'love',emoji:'‚ù§Ô∏è',label:'ÂñúÊ¨¢'},
        {id:'amazing',emoji:'üòç',label:'ÊÉäËâ≥'},
        {id:'funny',emoji:'üòÇ',label:'ÊúâË∂£'},
        {id:'wow',emoji:'üòÆ',label:'ÈúáÊíº'},
        {id:'sad',emoji:'üò¢',label:'ÊÑü‰º§'},
        {id:'fire',emoji:'üî•',label:'ÁÅ´'},
        {id:'sparkle',emoji:'‚ú®',label:'Èó™ËÄÄ'}
    ];
    let reactionPickerOpen=false,currentReactionData={reactions:{},userReaction:null};

    function toggleReactionPicker(){reactionPickerOpen=!reactionPickerOpen;document.getElementById('reaction-picker').style.display=reactionPickerOpen?'block':'none';if(reactionPickerOpen)loadReactions()}
    function closeReactionPicker(){reactionPickerOpen=false;document.getElementById('reaction-picker').style.display='none'}

    async function loadReactions(){const p=viewerPhotos[viewerIdx];if(!p)return;try{const r=await fetch(`${API}/photos/${p.id}/reactions`);const d=await r.json();currentReactionData=d;renderReactionGrid();updateReactBtn()}catch(e){}}
    async function loadReactionsQuiet(){const p=viewerPhotos[viewerIdx];if(!p)return;try{const r=await fetch(`${API}/photos/${p.id}/reactions`);const d=await r.json();currentReactionData=d;updateReactBtn()}catch(e){}}

    function renderReactionGrid(){const grid=document.getElementById('reaction-grid');grid.innerHTML=REACTIONS.map(r=>{const count=currentReactionData.reactions?.[r.id]||0;const selected=currentReactionData.userReaction===r.id;return`<button class="reaction-item${selected?' selected':''}" onclick="react('${r.id}')" title="${r.label}"><span class="emoji">${r.emoji}</span>${count>0?`<span class="rcount">${count}</span>`:''}</button>`}).join('')}

    async function react(type){const p=viewerPhotos[viewerIdx];if(!p)return;
    if(currentReactionData.userReaction===type){try{await fetch(`${API}/photos/${p.id}/reactions`,{method:'DELETE'});currentReactionData.userReaction=null;currentReactionData.reactions[type]=Math.max(0,(currentReactionData.reactions[type]||1)-1);renderReactionGrid();updateReactBtn()}catch(e){}}
    else{try{await fetch(`${API}/photos/${p.id}/reactions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({reaction_type:type})});if(currentReactionData.userReaction){const old=currentReactionData.userReaction;currentReactionData.reactions[old]=Math.max(0,(currentReactionData.reactions[old]||1)-1)}currentReactionData.userReaction=type;currentReactionData.reactions[type]=(currentReactionData.reactions[type]||0)+1;renderReactionGrid();updateReactBtn()}catch(e){}}}

    function updateReactBtn(){const btn=document.getElementById('viewer-react');btn.classList.toggle('has-reaction',!!currentReactionData.userReaction)}

    // Touch swipe
    let touchStartX=0;document.getElementById('viewer')?.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX},{passive:true});
    document.getElementById('viewer')?.addEventListener('touchend',e=>{const diff=e.changedTouches[0].clientX-touchStartX;if(Math.abs(diff)>50){diff>0?viewerPrev():viewerNext()}},{passive:true});

    // Deep link: open photo from URL ?photo=ID
    function checkDeepLink(){const params=new URLSearchParams(window.location.search);const photoId=params.get('photo');if(photoId){const waitForPhotos=setInterval(()=>{if(allPhotos.length>0){clearInterval(waitForPhotos);const id=parseInt(photoId);if(id)openViewer(id)}},200);setTimeout(()=>clearInterval(waitForPhotos),5000)}}

    document.addEventListener('DOMContentLoaded',()=>{initTheme();loadCats();loadPhotos(1);checkDeepLink()});
    </script>
</body>
</html>
