<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MYGallery - ÊàëÁöÑÁÖßÁâáÂ¢ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lg-zoom.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lg-thumbnail.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow: rgba(0, 0, 0, 0.08);
            --accent: #3b82f6;
            --accent-light: rgba(59, 130, 246, 0.1);
        }

        .dark-mode {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(30, 41, 59, 0.8);
            --glass-border: rgba(255, 255, 255, 0.08);
            --shadow: rgba(0, 0, 0, 0.4);
            --accent: #60a5fa;
            --accent-light: rgba(96, 165, 250, 0.15);
        }

        * { box-sizing: border-box; }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.4s ease, color 0.3s ease;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .dark-mode .text-gray-800, .dark-mode h1, .dark-mode h2, .dark-mode h3, .dark-mode p { color: var(--text-primary) !important; }
        .dark-mode .text-gray-600, .dark-mode .text-gray-700, .dark-mode .text-gray-500 { color: var(--text-secondary) !important; }

        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--glass-border);
        }

        .photo-card {
            break-inside: avoid;
            page-break-inside: avoid;
            position: relative;
            margin-bottom: 16px;
        }

        .photo-card .card-inner {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            box-shadow: 0 2px 12px var(--shadow);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
            background: var(--bg-secondary);
        }

        .photo-card .card-inner:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .photo-description {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.75) 0%, rgba(0,0,0,0.3) 60%, transparent 100%);
            padding: 40px 16px 16px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .photo-card .card-inner:hover .photo-description,
        .photo-card.touch-active .photo-description { opacity: 1; }

        .photo-card img {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: block;
        }
        .photo-card .card-inner:hover img { transform: scale(1.05); }

        .masonry-grid { column-count: 4; column-gap: 16px; padding: 0 4px; }
        @media (max-width: 1200px) { .masonry-grid { column-count: 3; } }
        @media (max-width: 768px)  { .masonry-grid { column-count: 2; column-gap: 10px; } }
        @media (max-width: 480px)  { .masonry-grid { column-count: 2; column-gap: 8px; } }

        .lazy-image { opacity: 0; transition: opacity 0.5s ease-in; }
        .lazy-loaded { opacity: 1; }

        .lg-backdrop { background-color: rgba(0, 0, 0, 0.85) !important; backdrop-filter: blur(30px) !important; -webkit-backdrop-filter: blur(30px) !important; }
        .lg-sub-html { background: rgba(0, 0, 0, 0.5) !important; backdrop-filter: blur(20px) !important; -webkit-backdrop-filter: blur(20px) !important; }

        .category-btn {
            background: var(--accent-light);
            border: 1.5px solid transparent;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
            padding: 8px 20px;
            border-radius: 999px;
            transition: all 0.25s ease;
            white-space: nowrap;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .category-btn:hover { background: var(--accent); color: white; transform: translateY(-1px); }
        .category-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); }

        .live-badge {
            position: absolute; top: 8px; left: 8px;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            color: #fff; font-size: 11px; font-weight: 600;
            padding: 3px 8px; border-radius: 6px;
            display: flex; align-items: center; gap: 4px;
            z-index: 5;
        }
        .live-badge::before { content: ''; width: 6px; height: 6px; background: #f43f5e; border-radius: 50%; animation: livePulse 1.5s infinite; }
        @keyframes livePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        #search-bar { animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .scroll-top {
            position: fixed; bottom: 24px; right: 24px;
            width: 48px; height: 48px;
            background: var(--accent); color: white;
            border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            opacity: 0; transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 40;
            -webkit-tap-highlight-color: transparent;
        }
        .scroll-top.visible { opacity: 1; transform: translateY(0); }
        .scroll-top:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(59, 130, 246, 0.5); }

        .mobile-menu-btn {
            display: none; padding: 8px; cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        @media (max-width: 768px) {
            .mobile-menu-btn { display: flex; align-items: center; }
            .desktop-nav { display: none !important; }
            .mobile-nav {
                position: fixed; top: 64px; left: 0; right: 0;
                background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
                border-bottom: 1px solid var(--glass-border);
                padding: 16px 24px; z-index: 45;
                transform: translateY(-100%); opacity: 0;
                transition: all 0.3s ease;
            }
            .mobile-nav.open { transform: translateY(0); opacity: 1; }
            .hero-title { font-size: 1.75rem !important; }
            .photo-card { margin-bottom: 10px; }
            .photo-card .card-inner { border-radius: 12px; }
            .photo-description { padding: 30px 12px 12px; }
            .photo-description h3 { font-size: 14px !important; }
            .photo-description p { font-size: 11px !important; }
        }

        footer { color: var(--text-secondary); }

        .exif-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; background: rgba(255,255,255,0.15); border-radius: 999px; font-size: 13px; backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <header class="glass-effect fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 sm:py-4">
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center space-x-2 no-underline">
                    <span class="text-2xl sm:text-3xl">üì∑</span>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-800">MYGallery</h1>
                </a>
                <nav class="desktop-nav flex items-center space-x-6">
                    <a href="#" class="text-gray-700 hover:text-blue-600 transition font-medium">È¶ñÈ°µ</a>
                    <button id="theme-toggle" class="p-2 rounded-xl hover:bg-gray-200/50 transition" title="ÂàáÊç¢‰∏ªÈ¢ò">
                        <span class="text-xl">üåô</span>
                    </button>
                </nav>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="ËèúÂçï">
                    <svg id="menu-icon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- ÁßªÂä®Á´ØÂØºËà™ -->
    <div id="mobile-nav" class="mobile-nav">
        <div class="flex flex-col space-y-4">
            <a href="#" class="text-gray-700 font-medium text-lg">È¶ñÈ°µ</a>
            <button onclick="toggleTheme()" class="text-left text-gray-700 font-medium text-lg flex items-center gap-2">
                <span id="mobile-theme-icon">üåô</span> ÂàáÊç¢‰∏ªÈ¢ò
            </button>
        </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 pt-20 sm:pt-24 pb-12">
        <!-- Ê†áÈ¢òÂå∫Âüü -->
        <div class="text-center mb-6 sm:mb-8">
            <h2 class="hero-title text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Á≤æÈÄâÊó∂Âàª ¬∑ ÁæéÂ•ΩÂõûÂøÜ</h2>
            <p class="text-gray-600 text-sm sm:text-base" id="photo-count">ÂÖ± 0 Âº†ÁÖßÁâá</p>
        </div>

        <!-- ÂàÜÁ±ªÁ≠õÈÄâ -->
        <div class="mb-6 sm:mb-8">
            <div class="flex flex-nowrap items-center justify-start sm:justify-center gap-2 sm:gap-3 mb-4 overflow-x-auto pb-2 px-1 scrollbar-hide" id="category-filter" style="-webkit-overflow-scrolling: touch; scrollbar-width: none;">
                <button onclick="filterByCategory('')" class="category-btn active">ÂÖ®ÈÉ®</button>
            </div>

            <div class="flex justify-center">
                <div class="relative w-full max-w-2xl">
                    <button id="search-toggle" onclick="toggleSearch()" class="category-btn flex items-center gap-2">
                        üîç ÊêúÁ¥¢ÁÖßÁâá
                    </button>
                    <div id="search-bar" class="hidden mt-3 rounded-2xl p-4 shadow-lg" style="background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--glass-border);">
                        <div class="relative">
                            <input type="text" id="search-input"
                                   placeholder="ÊêúÁ¥¢Ê†áÈ¢ò„ÄÅÊèèËø∞„ÄÅÊ†áÁ≠æ„ÄÅ‰ΩçÁΩÆ..."
                                   class="w-full px-4 py-3 pr-24 border-0 rounded-xl outline-none text-sm sm:text-base"
                                   style="background: var(--bg-secondary); color: var(--text-primary);"
                                   onkeyup="handleSearch(event)">
                            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex space-x-2">
                                <button type="button" onclick="performSearch()" class="px-4 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition">ÊêúÁ¥¢</button>
                                <button type="button" onclick="clearSearch()" class="px-3 py-1.5 text-sm rounded-lg transition" style="background: var(--accent-light); color: var(--text-primary);">Ê∏ÖÈô§</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="flex justify-center items-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-[3px] border-blue-200 border-t-blue-600"></div>
        </div>
        <div id="photo-wall" class="masonry-grid hidden"></div>
        <div id="empty-state" class="hidden text-center py-20">
            <div class="text-6xl mb-4">üì∏</div>
            <h3 class="text-2xl font-semibold text-gray-700 mb-2">ËøòÊ≤°ÊúâÁÖßÁâá</h3>
            <p class="text-gray-500">Êï¨ËØ∑ÊúüÂæÖÊõ¥Â§öÁ≤æÂΩ©ÁÖßÁâá</p>
        </div>
        <div id="load-more" class="hidden text-center mt-8">
            <button onclick="loadMore()" class="px-8 py-3 rounded-xl font-medium transition" style="background: var(--bg-secondary); box-shadow: 0 2px 12px var(--shadow); color: var(--text-primary);">Âä†ËΩΩÊõ¥Â§ö</button>
        </div>
    </main>

    <footer class="text-center py-8">
        <p class="text-sm">¬© <script>document.write(new Date().getFullYear())</script> MYGallery - ‰∏™‰∫∫ÁÖßÁâáÂ±ïÁ§∫‰∏éÁÆ°ÁêÜÁ≥ªÁªü</p>
    </footer>

    <button class="scroll-top" id="scroll-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚Üë</button>

    <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script>

    <script>
        const API_BASE = '/api';
        let currentPage = 1, totalPhotos = 0, isLoading = false;
        let allPhotos = [], currentCategory = '', currentSearch = '';
        const isTouchDevice = 'ontouchstart' in window;

        // Mobile menu
        function toggleMobileMenu() {
            document.getElementById('mobile-nav').classList.toggle('open');
        }

        // Theme
        function initThemeToggle() {
            const saved = localStorage.getItem('theme') || 'light';
            if (saved === 'dark') applyDark(true);
            document.getElementById('theme-toggle')?.addEventListener('click', () => toggleTheme());
        }
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            applyDark(isDark);
        }
        function applyDark(isDark) {
            if (isDark) document.body.classList.add('dark-mode');
            const icon = isDark ? '‚òÄÔ∏è' : 'üåô';
            const t = document.querySelector('#theme-toggle span'); if (t) t.textContent = icon;
            const m = document.getElementById('mobile-theme-icon'); if (m) m.textContent = icon;
        }

        // Scroll to top
        window.addEventListener('scroll', () => {
            const btn = document.getElementById('scroll-top');
            btn.classList.toggle('visible', window.scrollY > 400);
        });

        // Categories
        async function loadCategories() {
            try {
                const res = await fetch(`${API_BASE}/categories`);
                const categories = await res.json();
                const el = document.getElementById('category-filter');
                el.innerHTML = `<button onclick="filterByCategory('')" class="category-btn active">ÂÖ®ÈÉ®</button>` +
                    categories.map(c => `<button onclick="filterByCategory('${c.name}')" class="category-btn" data-category="${c.name}">${c.name}</button>`).join('');
            } catch (e) { console.log('Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•:', e); }
        }

        function filterByCategory(cat) {
            currentCategory = cat; currentPage = 1;
            document.querySelectorAll('.category-btn').forEach(b => {
                b.classList.toggle('active', (cat === '' && b.textContent.includes('ÂÖ®ÈÉ®')) || b.dataset.category === cat);
            });
            loadPhotos(1);
        }

        function toggleSearch() {
            const bar = document.getElementById('search-bar');
            bar.classList.toggle('hidden');
            if (!bar.classList.contains('hidden')) document.getElementById('search-input').focus();
        }

        let searchTimer;
        function handleSearch(e) {
            if (e.key === 'Enter') { performSearch(); return; }
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                if (document.getElementById('search-input').value.trim().length > 0) performSearch();
            }, 300);
        }
        function performSearch() {
            clearTimeout(searchTimer);
            currentSearch = document.getElementById('search-input').value.trim();
            currentPage = 1; loadPhotos(1);
        }
        function clearSearch() {
            document.getElementById('search-input').value = '';
            currentSearch = ''; loadPhotos(1);
        }

        async function loadPhotos(page = 1) {
            if (isLoading) return; isLoading = true;
            try {
                let url = `${API_BASE}/photos?page=${page}&size=20`;
                if (currentCategory) url += `&category=${encodeURIComponent(currentCategory)}`;
                if (currentSearch) url += `&search=${encodeURIComponent(currentSearch)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                totalPhotos = data.total;
                const ct = currentCategory ? `${currentCategory} ÂàÜÁ±ª: ${totalPhotos} Âº†ÁÖßÁâá`
                    : currentSearch ? `ÊêúÁ¥¢ÁªìÊûú: ${totalPhotos} Âº†ÁÖßÁâá`
                    : `ÂÖ± ${totalPhotos} Âº†ÁÖßÁâá`;
                document.getElementById('photo-count').textContent = ct;
                if (data.photos?.length > 0) {
                    allPhotos = page === 1 ? data.photos : [...allPhotos, ...data.photos];
                    renderPhotos(data.photos, page === 1);
                    document.getElementById('photo-wall').classList.remove('hidden');
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('empty-state').classList.add('hidden');
                    document.getElementById('load-more').classList.toggle('hidden', !(data.photos.length === 20 && data.total > page * 20));
                } else if (page === 1) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('photo-wall').classList.add('hidden');
                }
            } catch (e) {
                document.getElementById('loading').innerHTML = `<div class="text-center py-12"><div class="text-5xl mb-4">üò¢</div><p class="text-red-500 mb-4">Âä†ËΩΩÂ§±Ë¥•: ${e.message}</p><button onclick="loadPhotos(1)" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition">ÈáçËØï</button></div>`;
            } finally { isLoading = false; }
        }

        function renderPhotos(photos, replace = false) {
            const wall = document.getElementById('photo-wall');
            if (replace) wall.innerHTML = '';
            const frag = document.createDocumentFragment();
            photos.forEach(p => frag.appendChild(createPhotoCard(p)));
            wall.appendChild(frag);
            if (replace) {
                const init = () => {
                    try {
                        if (window.lgInstance) window.lgInstance.destroy();
                        window.lgInstance = lightGallery(wall, { selector: '.photo-item', plugins: [lgZoom, lgThumbnail], speed: 400, download: false });
                    } catch (e) { console.error('lightGallery ÂàùÂßãÂåñÂ§±Ë¥•:', e); }
                };
                'requestIdleCallback' in window ? requestIdleCallback(init) : setTimeout(init, 100);
            }
            initLazyLoad();
        }

        function createPhotoCard(photo) {
            const card = document.createElement('div');
            card.className = 'photo-card photo-item';
            card.setAttribute('data-src', photo.url);
            card.setAttribute('data-sub-html', createPhotoInfo(photo));
            if (isTouchDevice) {
                card.addEventListener('touchstart', function() { this.classList.add('touch-active'); });
                card.addEventListener('touchend', function() { setTimeout(() => this.classList.remove('touch-active'), 1500); });
            }

            const exif = [];
            if (photo.camera_model) exif.push(photo.camera_model);
            if (photo.aperture) exif.push(photo.aperture);
            if (photo.shutter_speed) exif.push(photo.shutter_speed);
            if (photo.iso) exif.push(`ISO ${photo.iso}`);

            const imgUrl = photo.url?.startsWith('http') ? photo.url : `/uploads/${photo.filename}`;
            const thumb = photo.thumbnail_url || imgUrl;

            card.innerHTML = `
                <div class="card-inner">
                    ${photo.is_live_photo ? '<div class="live-badge">LIVE</div>' : ''}
                    <img data-src="${thumb}"
                         src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect fill='%23e2e8f0' width='400' height='300'/%3E%3C/svg%3E"
                         alt="${photo.title || photo.original_name}"
                         class="w-full h-auto lazy-image" loading="lazy"
                         onerror="this.src='${imgUrl}'">
                    <div class="photo-description">
                        <h3 class="font-semibold text-base sm:text-lg mb-1">${photo.title || photo.original_name}</h3>
                        ${photo.description ? `<p class="text-sm text-gray-200 mb-1 line-clamp-2">${photo.description}</p>` : ''}
                        ${exif.length ? `<p class="text-xs text-gray-300 opacity-80">${exif.join(' ¬∑ ')}</p>` : ''}
                        ${photo.location ? `<p class="text-xs text-gray-300 mt-1 opacity-80">üìç ${photo.location}</p>` : ''}
                    </div>
                </div>`;
            return card;
        }

        function createPhotoInfo(photo) {
            let h = '<div style="max-width:900px;margin:0 auto;text-align:center;">';
            h += `<h4 style="font-size:1.25rem;font-weight:700;margin-bottom:8px;">${photo.title || photo.original_name}</h4>`;
            if (photo.description) h += `<p style="margin-bottom:12px;opacity:0.9;">${photo.description}</p>`;

            h += '<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:12px;">';
            if (photo.is_live_photo) h += '<span class="exif-tag" style="background:rgba(244,63,94,0.3);">‚óè LIVE</span>';
            if (photo.location) h += `<span class="exif-tag">üìç ${photo.location}</span>`;
            if (photo.category) h += `<span class="exif-tag">üìÅ ${photo.category}</span>`;
            if (photo.date_taken) h += `<span class="exif-tag">üïê ${new Date(photo.date_taken).toLocaleDateString('zh-CN')}</span>`;
            h += '</div>';

            const hasDevice = photo.camera_make || photo.camera_model || photo.lens_model || photo.software;
            const hasParams = photo.focal_length || photo.aperture || photo.shutter_speed || photo.iso;
            const hasExtra = photo.white_balance || photo.flash || photo.exposure_mode || photo.metering_mode || photo.exposure_bias;

            if (hasDevice || hasParams || hasExtra) {
                h += '<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:16px;margin-top:8px;font-size:13px;">';
                if (hasDevice) {
                    h += '<div style="text-align:center;"><p style="opacity:0.5;font-size:11px;margin-bottom:4px;">üì∏ ËÆæÂ§á</p>';
                    if (photo.camera_make || photo.camera_model) h += `<p>${[photo.camera_make, photo.camera_model].filter(Boolean).join(' ')}</p>`;
                    if (photo.lens_model) h += `<p style="opacity:0.8;">${photo.lens_model}</p>`;
                    if (photo.software) h += `<p style="opacity:0.6;font-size:11px;">${photo.software}</p>`;
                    h += '</div>';
                }
                if (hasParams) {
                    h += '<div style="text-align:center;"><p style="opacity:0.5;font-size:11px;margin-bottom:4px;">‚öôÔ∏è ÂèÇÊï∞</p>';
                    h += `<p>${[photo.focal_length, photo.aperture, photo.shutter_speed, photo.iso ? 'ISO '+photo.iso : ''].filter(Boolean).join(' ¬∑ ')}</p>`;
                    if (photo.exposure_bias) h += `<p style="opacity:0.8;">${photo.exposure_bias}</p>`;
                    h += '</div>';
                }
                if (hasExtra) {
                    h += '<div style="text-align:center;"><p style="opacity:0.5;font-size:11px;margin-bottom:4px;">üîß ËØ¶ÊÉÖ</p>';
                    const extras = [photo.exposure_mode, photo.metering_mode, photo.white_balance, photo.flash, photo.color_space].filter(Boolean);
                    h += `<p>${extras.join(' ¬∑ ')}</p>`;
                    h += '</div>';
                }
                if (photo.width && photo.height) {
                    h += `<div style="text-align:center;"><p style="opacity:0.5;font-size:11px;margin-bottom:4px;">üìê Â∞∫ÂØ∏</p><p>${photo.width} √ó ${photo.height}</p></div>`;
                }
                h += '</div>';
            }
            h += '</div>';
            return h;
        }

        function loadMore() { currentPage++; loadPhotos(currentPage); }

        let lazyObs;
        function initLazyLoad() {
            if (!lazyObs) lazyObs = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    if (e.isIntersecting && e.target.dataset.src) {
                        e.target.src = e.target.dataset.src;
                        e.target.classList.remove('lazy-image');
                        e.target.classList.add('lazy-loaded');
                        lazyObs.unobserve(e.target);
                    }
                });
            }, { rootMargin: '100px' });
            document.querySelectorAll('.lazy-image').forEach(i => lazyObs.observe(i));
        }

        let scrollT;
        function initInfiniteScroll() {
            window.addEventListener('scroll', () => {
                if (scrollT) return;
                scrollT = setTimeout(() => {
                    scrollT = null;
                    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 && !isLoading) {
                        const btn = document.getElementById('load-more');
                        if (!btn.classList.contains('hidden')) loadMore();
                    }
                }, 100);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initThemeToggle(); loadCategories(); loadPhotos(1); initInfiniteScroll();
        });
    </script>
</body>
</html>
