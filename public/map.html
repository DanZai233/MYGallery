<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…§ç‰‡åœ°å›¾ - MYGallery</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;overflow:hidden}
        #map{width:100vw;height:100vh}
        .home-btn{position:fixed;top:16px;left:16px;z-index:1000;width:44px;height:44px;background:rgba(255,255,255,.85);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(0,0,0,.1);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;text-decoration:none;color:#333;box-shadow:0 2px 12px rgba(0,0,0,.1);transition:all .2s}
        .home-btn:hover{background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.15);transform:translateY(-1px)}
        .zoom-ctrl{position:fixed;bottom:24px;left:16px;z-index:1000;display:flex;flex-direction:column;border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.1);border:1px solid rgba(0,0,0,.1)}
        .zoom-btn{width:40px;height:40px;background:rgba(255,255,255,.85);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:#333;border:none;border-bottom:1px solid rgba(0,0,0,.08);transition:background .2s}
        .zoom-btn:last-child{border-bottom:none} .zoom-btn:hover{background:#fff}
        .stats-badge{position:fixed;top:16px;right:16px;z-index:1000;background:rgba(255,255,255,.85);backdrop-filter:blur(12px);border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:8px 16px;font-size:13px;color:#333;box-shadow:0 2px 12px rgba(0,0,0,.1)}
        .photo-popup{min-width:240px;max-width:300px}
        .photo-popup img{width:100%;height:150px;object-fit:cover;border-radius:8px;margin-bottom:8px}
        .photo-popup h3{font-size:15px;font-weight:600;margin-bottom:4px;color:#1f2937}
        .photo-popup p{font-size:12px;color:#6b7280;margin-bottom:2px}
        .photo-popup .exif-line{font-size:11px;color:#9ca3af}
        .photo-popup a{display:inline-block;margin-top:6px;font-size:12px;color:#3b82f6;text-decoration:none}
        .leaflet-popup-content-wrapper{border-radius:12px!important;box-shadow:0 8px 30px rgba(0,0,0,.15)!important;border:1px solid rgba(0,0,0,.05)!important}
        .leaflet-popup-close-button{font-size:16px!important;color:#999!important;top:8px!important;right:8px!important}
        .photo-marker{width:40px;height:40px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.3);background-size:cover;background-position:center;cursor:pointer;transition:transform .2s}
        .photo-marker:hover{transform:scale(1.15)}
        .cluster-icon{background:rgba(59,130,246,.8);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;border:3px solid #fff;box-shadow:0 2px 12px rgba(59,130,246,.4)}
        .no-photos{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;background:rgba(255,255,255,.9);backdrop-filter:blur(20px)}
        .no-photos h2{font-size:24px;color:#374151;margin-bottom:8px} .no-photos p{color:#6b7280;margin-bottom:16px}
        .no-photos a{padding:8px 20px;background:#3b82f6;color:#fff;border-radius:10px;text-decoration:none;font-weight:500}
    </style>
</head>
<body>
    <a href="/" class="home-btn" title="è¿”å›é¦–é¡µ">ğŸ </a>
    <div class="zoom-ctrl">
        <button class="zoom-btn" onclick="map.zoomIn()" title="æ”¾å¤§">+</button>
        <button class="zoom-btn" onclick="map.zoomOut()" title="ç¼©å°">âˆ’</button>
        <button class="zoom-btn" onclick="resetView()" title="é‡ç½®">âŠ™</button>
    </div>
    <div class="stats-badge" id="stats"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
    const map = L.map('map',{zoomControl:false}).setView([35,105],4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    const markers = L.markerClusterGroup({
        maxClusterRadius:60,
        iconCreateFunction:function(cluster){
            const count=cluster.getChildCount();
            const size=count<10?40:count<50?50:60;
            return L.divIcon({html:`<div class="cluster-icon" style="width:${size}px;height:${size}px">${count}</div>`,className:'',iconSize:[size,size]})
        }
    });

    let allGpsPhotos=[];
    let defaultBounds=null;

    async function loadPhotos(){
        try{
            const res=await fetch('/api/photos?size=1000');
            const data=await res.json();
            allGpsPhotos=(data.photos||[]).filter(p=>p.gps_latitude&&p.gps_longitude);
            document.getElementById('stats').textContent=`ğŸ—ºï¸ ${allGpsPhotos.length} å¼ ç…§ç‰‡æœ‰ä½ç½®ä¿¡æ¯`;
            if(allGpsPhotos.length===0){
                document.getElementById('map').insertAdjacentHTML('afterend','<div class="no-photos"><h2>ğŸ“ æš‚æ— å¸¦ä½ç½®ä¿¡æ¯çš„ç…§ç‰‡</h2><p>ä¸Šä¼ åŒ…å« GPS æ•°æ®çš„ç…§ç‰‡åï¼Œå®ƒä»¬å°†æ˜¾ç¤ºåœ¨åœ°å›¾ä¸Š</p><a href="/">è¿”å›é¦–é¡µ</a></div>');
                return;
            }
            allGpsPhotos.forEach(p=>{
                const thumb=p.thumbnail_url||p.url;
                const icon=L.divIcon({html:`<div class="photo-marker" style="background-image:url(${thumb})"></div>`,className:'',iconSize:[40,40],iconAnchor:[20,20]});
                const m=L.marker([p.gps_latitude,p.gps_longitude],{icon});
                const exif=[];
                if(p.camera_model)exif.push(p.camera_model);
                if(p.aperture)exif.push(p.aperture);
                if(p.shutter_speed)exif.push(p.shutter_speed);
                if(p.iso)exif.push('ISO '+p.iso);
                m.bindPopup(`<div class="photo-popup"><img src="${thumb}" alt="${p.title||p.original_name}" onerror="this.src='${p.url}'"><h3>${p.title||p.original_name}</h3>${p.location?`<p>ğŸ“ ${p.location}</p>`:''}${p.date_taken?`<p>ğŸ“… ${new Date(p.date_taken).toLocaleDateString('zh-CN')}</p>`:''}${exif.length?`<p class="exif-line">${exif.join(' Â· ')}</p>`:''}<a href="/" onclick="localStorage.setItem('openPhoto','${p.id}')">æŸ¥çœ‹è¯¦æƒ… â†’</a></div>`,{maxWidth:300});
                markers.addLayer(m);
            });
            map.addLayer(markers);
            defaultBounds=markers.getBounds();
            map.fitBounds(defaultBounds,{padding:[40,40]});
        }catch(e){console.error('åŠ è½½ç…§ç‰‡å¤±è´¥:',e)}
    }

    function resetView(){if(defaultBounds)map.fitBounds(defaultBounds,{padding:[40,40]})}
    loadPhotos();
    </script>
</body>
</html>
